{% load static %}

<nav class="bg-white/70 backdrop-blur-md shadow-sm py-3 sticky top-0 z-50 border-b border-slate-200">
  <div class="container mx-auto px-6 flex justify-between items-center flex-wrap">
    
    <a href="/" class="font-bold text-xl text-blue-600 hover:text-blue-700 transition-colors">
      LigaPass
    </a>

    <div class="hidden md:flex space-x-14">
      <a id="nav-home" href="/" class="font-semibold text-slate-800 hover:text-blue-600 transition">HOME</a>
      <a id="nav-matches" href="/matches/" class="font-semibold text-slate-800 hover:text-blue-600 transition">MATCHES</a>
      <a id="nav-news" href="/news/" class="font-semibold text-slate-800 hover:text-blue-600 transition">NEWS</a>
      <a id="navbar-manage-link" href="/matches/manage/" class="font-semibold text-red-600 hover:text-red-700 transition hidden">MANAGE</a>
    </div>

    <div id="navbar-user-section" class="hidden md:flex items-center space-x-6">
      <a href="{% url 'authentication:login' %}" class="text-blue-600 hover:text-blue-700 font-medium transition hidden" id="navbar-login-link">Login</a>
      <a href="{% url 'authentication:register' %}" class="text-green-600 hover:text-green-700 font-medium transition hidden" id="navbar-register-link">Register</a>

      <div id="navbar-user-info" class="hidden flex items-center gap-4">
        <a id="navbar-profile-link" href="#">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-medium text-gray-800">Hi, <span id="navbar-username"></span></h2>
            <img id="navbar-profile-picture" src="" alt="Profile Picture"
              class="h-10 w-10 rounded-full object-cover border-2 border-white shadow-md">
          </div>
        </a>
        <button id="logoutButton" class="text-red-500 hover:text-red-600 font-medium transition">
          Logout
        </button>
      </div>
    </div>

    <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-slate-800 hover:bg-gray-100">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
      </svg>
    </button>

    <div id="mobile-menu" class="w-full md:hidden hidden mt-3">
      <a id="mobile-nav-home" href="/" class="block py-2 px-3 text-base font-semibold text-slate-800 rounded-md hover:bg-gray-100">HOME</a>
      <a id="mobile-nav-matches" href="/matches/" class="block py-2 px-3 text-base font-semibold text-slate-800 rounded-md hover:bg-gray-100">MATCHES</a>
      <a id="mobile-nav-news" href="/news/" class="block py-2 px-3 text-base font-semibold text-slate-800 rounded-md hover:bg-gray-100">NEWS</a>
      <a id="mobile-manage-link" href="/matches/manage/" class="block py-2 px-3 text-base font-semibold text-red-600 rounded-md hover:bg-gray-100 hidden">MANAGE</a>
      
      <div class="border-t border-gray-200 my-2"></div>

      <div id="mobile-user-guest" class="hidden">
        <a href="{% url 'authentication:login' %}" class="block py-2 px-3 text-base font-medium text-blue-600 rounded-md hover:bg-gray-100">Login</a>
        <a href="{% url 'authentication:register' %}" class="block py-2 px-3 text-base font-medium text-green-600 rounded-md hover:bg-gray-100">Register</a>
      </div>

      <div id="mobile-user-auth" class="hidden">
        <a id="mobile-profile-link" href="#" class="flex items-center gap-3 py-2 px-3 rounded-md hover:bg-gray-100">
          <img id="mobile-profile-picture" src="" alt="Profile" class="h-8 w-8 rounded-full object-cover border">
          <h2 class="text-base font-medium text-gray-800">Hi, <span id="mobile-username"></span></h2>
        </a>
        <button id="mobile-logoutButton" class="w-full text-left py-2 px-3 text-base font-medium text-red-500 rounded-md hover:bg-gray-100">
          Logout
        </button>
      </div>
    </div>

  </div>
</nav>

<div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-md hidden transition-opacity duration-300"></div>

{% block scripts %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

async function handleLogout() {
  const csrfToken = getCookie("csrftoken");
  try {
    const response = await fetch("{% url 'authentication:logout' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "X-Requested-With": "XMLHttpRequest",
      },
    });

    if (response.ok) {
      const data = await response.json();
      showToast(data.message || "Berhasil logout!", "success");
      setTimeout(() => window.location.href = data.redirect_url || "/", 1000);
    } else {
      showToast("Gagal logout!", "error");
    }
  } catch (error) {
    console.error("Logout error:", error);
    showToast("Terjadi kesalahan saat logout.", "error");
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  const DUMMY_USER_IMAGE = "{% static 'images/default-profile-picture.png' %}";
  
  // === Elemen User Desktop ===
  const userInfo = document.getElementById("navbar-user-info");
  const usernameEl = document.getElementById("navbar-username");
  const profilePic = document.getElementById("navbar-profile-picture");
  const loginLink = document.getElementById("navbar-login-link");
  const registerLink = document.getElementById("navbar-register-link");
  const profileLink = document.getElementById("navbar-profile-link");
  const logoutBtn = document.getElementById("logoutButton");
  const manageLink = document.getElementById("navbar-manage-link"); 

  // === Elemen User Mobile ===
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileAuth = document.getElementById("mobile-user-auth");
  const mobileGuest = document.getElementById("mobile-user-guest");
  const mobileUsernameEl = document.getElementById("mobile-username");
  const mobileProfilePic = document.getElementById("mobile-profile-picture");
  const mobileProfileLink = document.getElementById("mobile-profile-link");
  const mobileLogoutBtn = document.getElementById("mobile-logoutButton");
  const mobileManageLink = document.getElementById("mobile-manage-link"); 

  mobileMenuButton?.addEventListener("click", () => {
    mobileMenu.classList.toggle("hidden");
  });

  // === Logika Highlight Navigasi Aktif ===
  const currentPath = window.location.pathname;

  // Target Link Navigasi
  const navHome = document.getElementById("nav-home");
  const navMatches = document.getElementById("nav-matches");
  const navNews = document.getElementById("nav-news");
  const navManage = document.getElementById("navbar-manage-link"); // Sudah ada

  const mobileNavHome = document.getElementById("mobile-nav-home");
  const mobileNavMatches = document.getElementById("mobile-nav-matches");
  const mobileNavNews = document.getElementById("mobile-nav-news");
  const mobileNavManage = document.getElementById("mobile-manage-link"); // Sudah ada

  // Definisikan Kelas Aktif/Inaktif
  const activeDesktopClass = "text-blue-600";
  const inactiveDesktopClass = "text-slate-800";
  
  const activeMobileClass = "text-blue-600 bg-blue-50";
  const inactiveMobileClass = "text-slate-800";
  
  const activeManageDesktopClass = "text-red-700";
  const inactiveManageDesktopClass = "text-red-600";
  
  const activeManageMobileClass = "text-red-700 bg-red-50";
  const inactiveManageMobileClass = "text-red-600";

  // Logika Penyesuaian (mulai dari yang paling spesifik)
  if (currentPath.startsWith("/matches/manage/")) {
    navManage?.classList.remove(inactiveManageDesktopClass, "hover:text-red-700");
    navManage?.classList.add(activeManageDesktopClass);
    
    mobileNavManage?.classList.remove(inactiveManageMobileClass, "hover:bg-gray-100");
    mobileNavManage?.classList.add(...activeManageMobileClass.split(" "));

  } else if (currentPath.startsWith("/matches/")) {
    navMatches?.classList.remove(inactiveDesktopClass, "hover:text-blue-600");
    navMatches?.classList.add(activeDesktopClass);
    
    mobileNavMatches?.classList.remove(inactiveMobileClass, "hover:bg-gray-100");
    mobileNavMatches?.classList.add(...activeMobileClass.split(" "));

  } else if (currentPath.startsWith("/news/")) {
    navNews?.classList.remove(inactiveDesktopClass, "hover:text-blue-600");
    navNews?.classList.add(activeDesktopClass);
    
    mobileNavNews?.classList.remove(inactiveMobileClass, "hover:bg-gray-100");
    mobileNavNews?.classList.add(...activeMobileClass.split(" "));

  } else if (currentPath === "/") {
    navHome?.classList.remove(inactiveDesktopClass, "hover:text-blue-600");
    navHome?.classList.add(activeDesktopClass);
    
    mobileNavHome?.classList.remove(inactiveMobileClass, "hover:bg-gray-100");
    mobileNavHome?.classList.add(...activeMobileClass.split(" "));
  }
  // === [AKHIR BARU] Logika Highlight Navigasi Aktif ===


  // === Logika fetch user ===
  try {
    const response = await fetch("{% url 'profiles:current_user_json' %}");
    const data = await response.json();

    if (data.authenticated) {
      // Tampilkan info user di desktop
      userInfo.classList.remove("hidden");
      usernameEl.textContent = data.username;
      profilePic.src = data.profile_picture || DUMMY_USER_IMAGE;

      // Tampilkan info user di mobile
      mobileAuth.classList.remove("hidden");
      mobileUsernameEl.textContent = data.username;
      mobileProfilePic.src = data.profile_picture || DUMMY_USER_IMAGE;
      
      // Set link profile untuk desktop dan mobile
      let userProfileUrl = "#";
      if (data.role === "user") userProfileUrl = `/profiles/user/${data.id}/`;
      else if (data.role === "admin") userProfileUrl = `/profiles/admin/`;
      else if (data.role === "journalist") userProfileUrl = `/profiles/journalist/`;
      
      profileLink.href = userProfileUrl;
      mobileProfileLink.href = userProfileUrl;

      // Tampilkan tombol Manage jika admin
      if (data.role === "admin") {
        manageLink.classList.remove("hidden");
        mobileManageLink.classList.remove("hidden");
      }

    } else {
      loginLink.classList.remove("hidden");
      registerLink.classList.remove("hidden");
      mobileGuest.classList.remove("hidden");
    }
  } catch (error) {
    console.error("Error fetching user data:", error);
    loginLink.classList.remove("hidden");
    registerLink.classList.remove("hidden");
    mobileGuest.classList.remove("hidden");
  }

  logoutBtn?.addEventListener("click", handleLogout);
  mobileLogoutBtn?.addEventListener("click", handleLogout);
});

</script>
{% endblock %}