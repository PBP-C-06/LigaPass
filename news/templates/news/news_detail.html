<!-- Extend dari template dasar yang berisi struktur HTML umum (navbar dan footer) -->
{% extends "base.html" %}

<!-- Set judul halaman yang ditampilkan di tab browser -->
{% block title %}{{ news.title }} - LigaPass{% endblock %}
<<<<<<< HEAD

<!-- Blok konten utama halaman -->
=======
{% load static %}
>>>>>>> 2dbde66e09625f0490ddc275baff4f05b1984896
{% block content %}
<a href="{% url 'news:news_list' %}" class="inline-flex items-center text-blue-600 hover:underline mb-4">
  ‚Üê Kembali ke Daftar Berita
</a>

<!-- Judul besar halaman -->
<h1 class="text-3xl font-bold mb-2">{{ news.title }}</h1>

<div class="flex flex-wrap items-center gap-2 text-sm mb-4">

  <!-- Badge kategori -->
  {% if news.category %}
    {% if news.category == 'transfer' %}
      <span class="bg-blue-500 text-white font-semibold text-xs px-4 py-1 rounded-full">Transfer</span>
    {% elif news.category == 'update' %}
      <span class="bg-green-500 text-white font-semibold text-xs px-4 py-1 rounded-full">Pembaruan</span>
    {% elif news.category == 'exclusive' %}
      <span class="bg-purple-500 text-white font-semibold text-xs px-4 py-1 rounded-full">Eksklusif</span>
    {% elif news.category == 'match' %}
      <span class="bg-yellow-500 text-white font-semibold text-xs px-4 py-1 rounded-full">Pertandingan</span>
    {% elif news.category == 'rumor' %}
      <span class="bg-pink-500 text-white font-semibold text-xs px-4 py-1 rounded-full">Rumor</span>
    {% elif news.category == 'analysis' %}
      <span class="bg-indigo-500 text-white font-semibold text-xs px-4 py-1 rounded-full">Analisis</span>
    {% endif %}
  {% endif %}

  <!-- Badge featured -->
  {% if news.is_featured %}
    <span class="bg-red-500 text-white font-semibold text-xs px-4 py-1 rounded-full">Unggulan</span>
  {% endif %}

  <!-- Tanggal & views -->
  <span class="text-gray-500 ml-auto">
    {% if news.edited_at %}
      Diedit: {{ news.edited_at|date:"d M Y, H:i" }}
    {% else %}
      Dibuat: {{ news.created_at|date:"d M Y, H:i" }}
    {% endif %}
    | Dilihat: {{ news.news_views }}
  </span>
</div>

<div class="w-full max-w-xl my-4 overflow-hidden rounded shadow group mx-auto">
  {% if news.thumbnail and news.thumbnail.name != 'default.jpg' %}
    <img src="{{ news.thumbnail.url }}" alt="thumbnail"
         class="w-full h-[400px] object-cover transition-transform duration-300 ease-in-out group-hover:scale-105">
  {% else %}
    <img src="{% static 'images/thumbnail_placeholder.png' %}" alt="placeholder thumbnail"
         class="w-full h-[400px] object-cover opacity-90">
  {% endif %}
</div>

<div class="prose max-w-none leading-relaxed">
  {{ news.content|safe }}
</div>

{% if request.user.role == 'journalist' %}
  <div class="mt-6 flex gap-4">
    <a href="{% url 'news:news_edit' news.pk %}" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
    Edit Berita
    </a>
    <button onclick="openDeleteModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center gap-2">
    Hapus Berita
    </button>
  </div>
{% endif %}

<a href="{% url 'news:news_list' %}" class="inline-flex items-center text-blue-600 hover:underline mt-8 block">
  ‚Üê Kembali ke Daftar Berita
</a>

{% if recommended_news %}
  <hr class="my-10">
  <h2 class="text-2xl font-bold mb-4">Berita Lainnya</h2>
  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for item in recommended_news %}
      {% include 'news/news_card.html' with news=item %}
    {% endfor %}
  </div>
{% endif %}

<!-- Modal Konfirmasi Hapus -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
    <div class="text-red-600 text-3xl mb-2">üóëÔ∏è</div>
    <h3 class="text-lg font-semibold mb-2">Hapus Berita?</h3>
    <p class="text-gray-600 mb-4">Berita <strong>{{ news.title }}</strong> akan dihapus secara permanen.</p>
    <div class="flex justify-center gap-4">
      <button onclick="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Ya, Hapus</button>
      <button onclick="closeDeleteModal()" class="border border-gray-300 px-4 py-2 rounded hover:bg-gray-100">Batal</button>
    </div>
  </div>
</div>

<!-- Komentar -->
{% if request.user.is_authenticated %}
  <div class="mt-10">
    <h3 class="text-xl font-bold mb-2">Tinggalkan Komentar</h3>
    <form method="post" id="main-comment-form">
      {% csrf_token %}
      {{ comment_form }}
      <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Kirim Komentar
      </button>
    </form>
  </div>
{% else %}
  <p class="text-gray-600 mt-8">
    <a href="{% url 'login' %}" class="text-blue-600 underline">Login</a> untuk berkomentar.
  </p>
{% endif %}

<!-- Modal Konfirmasi Hapus Komentar -->
<div id="delete-comment-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
    <div class="text-red-600 text-3xl mb-2">üóëÔ∏è</div>
    <h3 class="text-lg font-semibold mb-2">Hapus Komentar?</h3>
    <p class="text-gray-600 mb-4">Komentar ini akan dihapus secara permanen.</p>
    <div class="flex justify-center gap-4">
      <button id="confirm-delete-comment-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Ya, Hapus</button>
      <button onclick="closeDeleteCommentModal()" class="border border-gray-300 px-4 py-2 rounded hover:bg-gray-100">Batal</button>
    </div>
  </div>
</div>

<div class="flex items-center justify-between mt-10 mb-4">
  <h3 class="text-xl font-bold">
    Komentar <span id="total-comment-count">({{ total_comments }})</span>
    <span class="text-sm font-normal text-gray-500" id="current-sort-label">
      {% if sort == 'popular' %}Terpopuler{% else %}Terbaru{% endif %}
    </span>
  </h3>
  <div class="flex gap-2">
    <button
      class="px-3 py-1 border rounded {% if sort == 'latest' %}bg-blue-600 text-white{% else %}text-gray-700{% endif %}"
      data-sort="latest">
      Terbaru
    </button>
    <button
      class="px-3 py-1 border rounded {% if sort == 'popular' %}bg-blue-600 text-white{% else %}text-gray-700{% endif %}"
      data-sort="popular">
      Terpopuler
    </button>
  </div>
</div>

<div id="comment-{{ comment.id }}" class="comments-container space-y-6">
  {% include "news/comment_list.html" %}
</div>

<!-- ========= SCRIPT BAGIAN BAWAH ========== -->
<script>
let currentSort = "{{ sort|default:'latest' }}";

// Fungsi untuk menyorot tombol sort yang aktif
function highlightSortButton() {
  document.querySelectorAll("button[data-sort]").forEach(btn => {
    const isActive = btn.dataset.sort === currentSort;
    btn.classList.toggle("bg-blue-600", isActive);
    btn.classList.toggle("text-white", isActive);
    btn.classList.toggle("text-gray-700", !isActive);
  });
}

// Fungsi untuk membuka modal konfirmasi hapus
function openDeleteModal() {
    const modal = document.getElementById("deleteModal");
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }
  }

  // Fungsi untuk menutup modal konfirmasi hapus
  function closeDeleteModal() {
    const modal = document.getElementById("deleteModal");
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  }

  // Fungsi untuk mengonfirmasi hapus berita
  function confirmDelete() {
    fetch("{% url 'news:news_delete' news.pk %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => {
      if (response.ok) {
        return response.json();
      }
      throw new Error("Gagal menghapus.");
    })
    .then(data => {
      if (data.success) {
        // Redirect setelah berhasil hapus
        window.location.href = "{% url 'news:news_list' %}";
      } else {
        alert("Gagal menghapus berita.");
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Terjadi kesalahan saat menghapus.");
    });
  }

  let commentIdToDelete = null;

  // Fungsi untuk membuka modal hapus komentar
  function openDeleteCommentModal(commentId) {
  commentIdToDelete = commentId;
  const modal = document.getElementById("delete-comment-modal");
  if (modal) {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }
}

// Fungsi untuk menutup modal hapus komentar
function closeDeleteCommentModal() {
  commentIdToDelete = null;
  const modal = document.getElementById("delete-comment-modal");
  if (modal) {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }
}

// Konfirmasi hapus komentar
document.getElementById("confirm-delete-comment-btn").addEventListener("click", async () => {
  if (!commentIdToDelete) return;

  try {
    const response = await fetch(`/news/comment/${commentIdToDelete}/delete/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest"
      },
      credentials: "same-origin"
    });

    if (response.ok) {
      const data = await response.json();

      // Hapus dari DOM
      const commentEl = document.getElementById(`comment-${commentIdToDelete}`);
      if (commentEl) commentEl.remove();

      // Update total komentar
      const countSpan = document.getElementById("total-comment-count");
      if (countSpan && data.total_comments !== undefined) {
        countSpan.textContent = `(${data.total_comments})`;
      }

      closeDeleteCommentModal();
    } else {
      alert("Gagal menghapus komentar.");
    }
  } catch (err) {
    console.error("Error hapus komentar:", err);
    alert("Terjadi kesalahan.");
  }
});

// Ambil CSRF token dari cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrfToken = getCookie('csrftoken');

  // Event delegation untuk form balasan komentar
  document.addEventListener("submit", async function (e) {
  const form = e.target;

  // Balasan komentar
  if (form.matches(".reply-form")) {
    e.preventDefault();
    const parentId = form.dataset.commentId;
    const formData = new FormData(form);

    try {
      const response = await fetch(window.location.href, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        credentials: "same-origin",
        body: formData
      });

      if (response.ok) {
        const data = await response.json();
        form.classList.add("hidden");
        form.querySelector("textarea").value = "";

        const wrapper = document.createElement("div");
        wrapper.innerHTML = data.comment_html;

        const repliesContainer = document.getElementById(`replies-${parentId}`);
        if (repliesContainer) {
          repliesContainer.appendChild(wrapper);
        }

        const countSpan = document.getElementById("total-comment-count");
        if (countSpan && data.total_comments !== undefined) {
          countSpan.textContent = `(${data.total_comments})`;
        }
      } else {
        alert("Gagal mengirim balasan.");
      }
    } catch (err) {
      console.error("Error:", err);
    }
  }

  // Like komentar
  if (form.matches("form[data-like-form]")) {
    e.preventDefault();

    try {
      const response = await fetch(form.action, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        credentials: "same-origin"
      });

      if (response.ok) {
        const data = await response.json();
        const btn = form.querySelector("button");
        const span = form.querySelector("span");

        if (data.liked) {
          btn.innerText = "‚ù§Ô∏è Unlike";
          btn.classList.replace("text-gray-600", "text-red-600");
        } else {
          btn.innerText = "ü§ç Like";
          btn.classList.replace("text-red-600", "text-gray-600");
        }

        span.innerText = `(${data.like_count})`;
      }
    } catch (err) {
      console.error("Error like:", err);
    }
  }

  // Komentar utama
  if (form.matches("#main-comment-form")) {
    e.preventDefault();

    const formData = new FormData(form);

    try {
      const response = await fetch(window.location.href, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        credentials: "same-origin",
        body: formData
      });

      if (response.ok) {
        const data = await response.json();
        form.reset();

        // Tambahkan komentar ke atas
        const wrapper = document.createElement("div");
        wrapper.innerHTML = data.comment_html;

        const container = document.querySelector(".comments-container");
        if (container) {
          container.prepend(wrapper);

          // Force browser to recognize the new form properly
          setTimeout(() => {
            const newForm = wrapper.querySelector("form.reply-form");
            if (newForm) newForm.reset(); // Just trigger recognition
          }, 100);
        }

         // Update total komentar
        const countSpan = document.getElementById("total-comment-count");
        if (countSpan && data.total_comments !== undefined) {
          countSpan.textContent = `(${data.total_comments})`;
        }

        // Set label sort jadi "Terbaru"
        const sortLabel = document.getElementById("current-sort-label");
        if (sortLabel) sortLabel.textContent = "Terbaru";
          currentSort = "latest";
          highlightSortButton();

        // Highlight tombol "Terbaru"
        document.querySelectorAll("button[data-sort]").forEach(btn => {
          if (btn.dataset.sort === "latest") {
            btn.classList.add("bg-blue-600", "text-white");
            btn.classList.remove("text-gray-700");
          } else {
            btn.classList.remove("bg-blue-600", "text-white");
            btn.classList.add("text-gray-700");
          }
        });

        } else {
          alert("Gagal mengirim komentar.");
        }
      } catch (err) {
        console.error("Error:", err);
      }
    }

  // Hapus komentar
  if (form.matches("form[data-delete-form]")) {
    e.preventDefault();

    const confirmed = confirm("Yakin ingin menghapus komentar ini?");
    if (!confirmed) return;

    try {
      const response = await fetch(form.action, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        credentials: "same-origin"
      });

      if (response.ok) {
        const data = await response.json();
        // Hapus elemen komentar dari DOM
        const commentBlock = form.closest(".comment-block");
        if (commentBlock) commentBlock.remove();

        // Update total komentar
        const countSpan = document.getElementById("total-comment-count");
        if (countSpan && data.total_comments !== undefined) {
          countSpan.textContent = `(${data.total_comments})`;
        }

      } else {
        alert("Gagal menghapus komentar.");
      }
    } catch (err) {
      console.error("Error hapus komentar:", err);
    }
  }
});

document.querySelectorAll("button[data-sort]").forEach(button => {
  button.addEventListener("click", async () => {
    const sortValue = button.dataset.sort;
    currentSort = sortValue;
    highlightSortButton();

    try {
      const response = await fetch(window.location.pathname + `?sort=${sortValue}`, {
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        },
        credentials: "same-origin"
      });

      if (response.ok) {
        const data = await response.json();
        const container = document.querySelector(".comments-container");

        if (container) {
          container.innerHTML = data.comments_html;

          // Update label sort juga kalau mau
          const sortLabel = document.querySelector("#current-sort-label");
          if (sortLabel) {
            sortLabel.textContent = sortValue === "popular" ? "Terpopuler" : "Terbaru";
          }

          // Reset ID komentar yang ingin dihapus
          commentIdToDelete = null;
        }
      } else {
        alert("Gagal memuat komentar.");
      }
    } catch (err) {
      console.error("AJAX filter error:", err);
    }
  });
});

  // Fungsi toggle reply form
  window.toggleReplyForm = function (commentId) {
    const form = document.getElementById(`reply-form-${commentId}`);
    if (form) {
      form.classList.toggle("hidden");
    }
  };
</script>
{% endblock %}