{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto py-10 px-6">
    <h1 class="text-3xl font-bold mb-8">User Analytics</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl p-6 shadow-md">
            <h2 class="text-lg font-semibold mb-4">Total Pengeluaran per Bulan</h2>
            <canvas id="spendingChart" width="400" height="250"></canvas>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-md">
            <h2 class="text-lg font-semibold mb-4">Distribusi Kategori Tiket Dibeli</h2>
            <canvas id="seatChart" width="400" height="250"></canvas>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    try {
        const res = await fetch("/reviews/analytics/user/data/");
        const data = await res.json();

        console.log("✅ Data Analytics:", data);

        const spendingLabels = data.spendingData.map(item => {
            const monthNames = [
                "Jan", "Feb", "Mar", "Apr", "Mei", "Jun", 
                "Jul", "Agu", "Sep", "Okt", "Nov", "Des"
            ];
            return monthNames[item.month - 1] + " " + item.year;
        });
        const spendingValues = data.spendingData.map(item => parseFloat(item.total_spent));

        new Chart(document.getElementById("spendingChart"), {
            type: "bar",
            data: {
                labels: spendingLabels,
                datasets: [{
                    label: "Total Pengeluaran (Rp)",
                    data: spendingValues,
                    backgroundColor: "#2563EB",
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, ticks: { callback: v => "Rp " + v.toLocaleString() } }
                }
            }
        });

      
        const seatLabels = data.seatCount.map(item => item.ticket_type__seat_category);
        const seatValues = data.seatCount.map(item => item.count);

        new Chart(document.getElementById("seatChart"), {
            type: "pie",
            data: {
                labels: seatLabels,
                datasets: [{
                    data: seatValues,
                    backgroundColor: ["#2563EB", "#F59E0B", "#10B981", "#EF4444"],
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: "bottom" } }
            }
        });

    } catch (err) {
        console.error("❌ Gagal memuat data analytics:", err);
    }
});
</script>
{% endblock %}
