{% load static %}

<div class="bg-white p-6 rounded-2xl shadow-md">
  <h2 class="text-xl font-bold mb-6">Review untuk {{ match.home_team.name }} vs {{ match.away_team.name }}</h2>

  {% for review in reviews %}
    <div class="border rounded-xl p-5 mb-6">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-semibold text-gray-700">
            {{ review.user.username|first|upper }}
          </div>
          <span class="font-semibold text-gray-800">{{ review.user.username }}</span>
        </div>
        <div class="flex text-yellow-400 text-sm">
          {% for i in "12345" %}
            {% if forloop.counter <= review.rating %}
              ★
            {% else %}
              <span class="text-gray-300">★</span>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <p class="text-gray-700 text-sm mb-2">{{ review.comment }}</p>
      <p class="text-xs text-gray-500">{{ review.created_at|date:"M d, Y • H:i" }}</p>

      {% if review.reply %}
        <div class="ml-6 mt-3 border-l-4 border-blue-400 pl-4 bg-blue-50 rounded-md">
          <p class="text-sm text-blue-800 font-semibold mb-1">Admin Reply</p>
          <p class="text-gray-700 text-sm">{{ review.reply.reply_text }}</p>
          <p class="text-xs text-gray-500 mt-1">
            {{ review.reply.created_at|date:"M d, Y • H:i" }} • {{ review.reply.admin.username }}
          </p>
        </div>
      {% else %}
        <button
          class="open-reply-modal bg-blue-600 text-white text-sm px-4 py-2 rounded mt-3 hover:bg-blue-700"
          data-review-id="{{ review.id }}">
          Reply
        </button>
      {% endif %}
    </div>
  {% empty %}
    <p class="text-gray-500">Belum ada review untuk pertandingan ini.</p>
  {% endfor %}
</div>

<!-- === Modal Pop-up untuk Balasan === -->
<div id="replyModal"
     class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">Tulis Balasan</h3>
    <form id="replyForm">
      {% csrf_token %}
      <textarea id="replyText" name="reply_text" rows="3"
                class="w-full border rounded-md p-2 mb-3 text-sm focus:ring focus:ring-blue-200"
                placeholder="Tulis balasan admin di sini..."></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelReply"
                class="text-gray-600 hover:text-gray-800 px-3 py-1 text-sm">Batal</button>
        <button type="submit"
                class="bg-blue-600 text-white text-sm px-4 py-1.5 rounded hover:bg-blue-700">Kirim</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("replyModal");
  const replyForm = document.getElementById("replyForm");
  const replyText = document.getElementById("replyText");
  let currentReviewId = null;

  // Buka modal
  document.querySelectorAll(".open-reply-modal").forEach(btn => {
    btn.addEventListener("click", () => {
      currentReviewId = btn.dataset.reviewId;
      modal.classList.remove("hidden");
      replyText.value = "";
      replyText.focus();
    });
  });

  // Tutup modal
  document.getElementById("cancelReply").addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  // Kirim balasan
  replyForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(replyForm);
    const res = await fetch(`/reviews/api/reply/${currentReviewId}/`, {
      method: "POST",
      headers: { "X-CSRFToken": replyForm.querySelector('[name=csrfmiddlewaretoken]').value },
      body: formData
    });
    const data = await res.json();
    if (data.ok) {
      alert("Balasan berhasil dikirim!");
      location.reload();
    } else {
      alert(data.message || "Gagal mengirim balasan");
    }
  });
});
</script>
