{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .aura {
    position: absolute;
    border-radius: 50%;
    opacity: 0.5;
    filter: blur(80px);
  }

  .aura-1 {
    background: linear-gradient(
      #627ad1,#8392d6
    );
    width: 800px; height: 800px;
    top: 100px; left: 400px;
    animation: move-aura-1 30s infinite alternate ease-in-out;
    filter: blur(60px);
  }

  .aura-2 {
    background: linear-gradient(
      #3147eb,#7a61d4
    );
    width: 600px; height: 600px;
    top: 1000px; left: 900px;
    animation: move-aura-2 30s infinite alternate ease-in-out;
    filter: blur(60px);
  }

  .aura-3 {
    background: linear-gradient(
      #8c9af5,#3246c2
    );
    width: 500px; height: 500px;
    top: 1000px; left: 150px;
    animation: move-aura-3 30s infinite alternate ease-in-out;
    filter: blur(60px);
  }

  .aura-4 {
    background: linear-gradient(
      #1931e6,#1327bf
    );
    width: 600px; height: 600px;
    top: 500px; left: 900px;
    animation: move-aura-2 40s infinite alternate ease-in-out;
    filter: blur(60px);
  }
  
  @keyframes move-aura-1 {
    0% { 
      transform: translate(0,0) scale(1); 
    }
    25% { 
      transform: translate(30vw, 10vh) scale(1.2); 
    }
    50% { 
      transform: translate(-30vw, 50vh) scale(1.3); 
    }
    75% { 
      transform: translate(-10vw, 40vh) scale(1.2); 
    }
    100% { 
      transform: translate(0,0) scale(1); 
    }
  }

  @keyframes move-aura-2 {
    0% { 
      transform: translate(0,0) scale(1); 
    }
    25% { 
      transform: translate(-70vw, 10vh) scale(1.2); 
    }
    50% { 
      transform: translate(-50vw, -50vh) scale(1.3); 
    }
    75% { 
      transform: translate(40vw, -50vh) scale(1.1); 
    }
    100% { 
      transform: translate(0,0) scale(1); 
    }
  }

  @keyframes move-aura-3 {
    0% { 
      transform: translate(0,0) scale(1); 
    }
    25% { 
      transform: translate(20vw, -50vh) scale(1.3); 
    }
    50% { 
      transform: translate(70vw, -30vh) scale(1.6); 
    }
    75% { 
      transform: translate(60vw, -70vh) scale(1.1); 
    }
    100% { 
      transform: translate(0,0) scale(1); 
    }
  }
</style>

<div class="flex justify-center items-center min-h-[80vh] px-4 py-8">

    <!-- Aura untuk di belakang card -->
    <div class="absolute inset-0 overflow-hidden z-0">
      <div class="aura aura-1"></div>
      <div class="aura aura-2"></div>
      <div class="aura aura-3"></div>
      <div class="aura aura-4"></div> 
    </div>

  <div class="bg-white/80 backdrop-blur-lg shadow-xl rounded-2xl p-8 w-full max-w-lg border border-slate-200">

    <!-- Heading -->
    <div class="text-center mb-4">
      <h2 class="text-xl font-semibold text-blue-600">LigaPass</h2>
    </div>

    <h1 class="text-2xl font-bold text-slate-800 mb-6 text-center">Daftar Akun Baru</h1>

    <form id="registerForm" method="POST" action="{% url 'authentication:register' %}" class="space-y-4">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
          {% for error in form.non_field_errors %}
            <span class="block sm:inline">{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          {{ form.first_name }}
          {% if form.first_name.errors %}
            <div class="text-red-600 text-xs mt-1">{% for error in form.first_name.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        <div>
          {{ form.last_name }}
          {% if form.last_name.errors %}
            <div class="text-red-600 text-xs mt-1">{% for error in form.last_name.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
      </div>

      <div>
        {{ form.username }}
        {% if form.username.errors %}
          <div class="text-red-600 text-xs mt-1">{% for error in form.username.errors %}{{ error }}{% endfor %}</div>
        {% endif %}
      </div>

      <div>
        {{ form.email }}
        {% if form.email.errors %}
          <div class="text-red-600 text-xs mt-1">{% for error in form.email.errors %}{{ error }}{% endfor %}</div>
        {% endif %}
      </div>

      <!-- Password 1 -->
      <div class="relative">
        {{ form.password1 }}
        <button type="button"
                class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600"
                onclick="togglePasswordVisibility('id_password1', this)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.98 8.223A10.477 10.477 0 001.934 12
            C3.226 16.338 7.244 19.5 12 19.5
            c.993 0 1.953-.138 2.863-.395M6.228 6.228
            A10.45 10.45 0 0112 4.5
            c4.756 0 8.773 3.162 10.065 7.498
            a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3
            m3.228 3.228l3.65 3.65m7.894 7.894L21 21
            m-3.228-3.228l-3.65-3.65
            m0 0a3 3 0 10-4.243-4.243
            m4.242 4.242L9.88 9.88" />
          </svg>
        </button>
      </div>
      {% if form.password1.errors %}
        <div class="text-red-600 text-xs -mt-3">
          {% for error in form.password1.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}

      <!-- Password 2 -->
      <div class="relative">
        {{ form.password2 }}
        <button type="button"
                class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600"
                onclick="togglePasswordVisibility('id_password2', this)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.98 8.223A10.477 10.477 0 001.934 12
            C3.226 16.338 7.244 19.5 12 19.5
            c.993 0 1.953-.138 2.863-.395M6.228 6.228
            A10.45 10.45 0 0112 4.5
            c4.756 0 8.773 3.162 10.065 7.498
            a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3
            m3.228 3.228l3.65 3.65m7.894 7.894L21 21
            m-3.228-3.228l-3.65-3.65
            m0 0a3 3 0 10-4.243-4.243
            m4.242 4.242L9.88 9.88" />
          </svg>
        </button>
      </div>
      {% if form.password2.errors %}
        <div class="text-red-600 text-xs -mt-3">
          {% for error in form.password2.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}

      <button type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out mt-6">
        Daftar Sekarang
      </button>
    </form>

    <div class="text-center mt-6 text-sm">
      <p class="text-slate-600">
        Sudah punya akun?
        <a href="{% url 'authentication:login' %}" class="text-blue-600 hover:text-blue-700 font-semibold underline hover:no-underline transition">
          Login
        </a>
      </p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const formInputs = document.querySelectorAll('#registerForm input');
    const placeholders = {
        'id_first_name': 'Nama Depan',
        'id_last_name': 'Nama Belakang',
        'id_username': 'Username',
        'id_email': 'Alamat Email Aktif',
        'id_password1': 'Buat Password',
        'id_password2': 'Ulangi Password'
    };
    const commonClasses = 'w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out placeholder-slate-400';
    const passwordClasses = 'pr-10';

    formInputs.forEach(input => {
      if (input.type === 'hidden') return;
      input.classList.add(...commonClasses.split(' '));
      if (placeholders[input.id]) input.setAttribute('placeholder', placeholders[input.id]);
      if (input.type === 'password' || input.id.includes('password'))
        input.classList.add(passwordClasses);
    });
  });

  // --- Fungsi Toggle Password ---
  function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const iconOpen = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`;
    const iconClosed = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/></svg>`;

    if (input.type === "password") {
      input.type = "text";
      button.innerHTML = iconOpen;
    } else {
      input.type = "password";
      button.innerHTML = iconClosed;
    }
  }

  const registerForm = document.getElementById('registerForm');
  registerForm.addEventListener('submit', async function(event) {
    event.preventDefault();

    const submitButton = registerForm.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Processing...`;

    // Hapus pesan error lama
    registerForm.querySelectorAll('.text-red-600').forEach(el => {
      el.textContent = '';
      el.classList.add('hidden');
    });

    const nonFieldErrorDiv = registerForm.querySelector('.bg-red-100');
    if (nonFieldErrorDiv) nonFieldErrorDiv.classList.add('hidden');

    const formData = new FormData(registerForm);
    const csrfToken = formData.get('csrfmiddlewaretoken');

    try {
      const response = await fetch(registerForm.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      });

      let data;
      try {
        data = await response.json();
      } catch (parseError) {
        showToast('Server mengembalikan response tidak valid', 'error');
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        return;
      }

      if (response.ok && data.status === 'success') {
        showToast(data.message || 'Registrasi berhasil!', 'success');
        setTimeout(() => {
          window.location.href = data.redirect_url;
        }, 1000);

      } else {
  
        if (data.errors) {
          let firstError = null;
          
          for (const fieldName in data.errors) {
            const errorArray = data.errors[fieldName];
            const firstErrorMsg = errorArray[0]; // Ambil error pertama saja
            const fieldInput = registerForm.querySelector(`#id_${fieldName}`);
            
            // Tampilkan error pertama di bawah field
            if (fieldInput) {
              const errorDiv = fieldInput.closest('div')?.querySelector('.text-red-600');
              if (errorDiv) {
                errorDiv.textContent = firstErrorMsg;
                errorDiv.classList.remove('hidden');
              }
            }
            
            // Simpan error pertama untuk toast
            if (!firstError) {
              if (fieldName === '__all__') {
                firstError = firstErrorMsg;
                if (nonFieldErrorDiv) {
                  nonFieldErrorDiv.innerHTML = `<span>${firstErrorMsg}</span>`;
                  nonFieldErrorDiv.classList.remove('hidden');
                }
              } else {
                const fieldLabel = {
                  'username': 'Username',
                  'email': 'Email',
                  'password1': 'Password',
                  'password2': 'Konfirmasi Password',
                  'first_name': 'Nama Depan',
                  'last_name': 'Nama Belakang'
                }[fieldName] || fieldName;
                
                firstError = `${fieldLabel}: ${firstErrorMsg}`;
              }
            }
          }
          
          // Tampilkan hanya error pertama dalam toast
          if (firstError) {
            showToast(firstError, 'error');
          } else {
            showToast('Terjadi kesalahan pada form.', 'error');
          }
        } else {
          showToast(data.message || 'Registrasi gagal.', 'error');
          if (nonFieldErrorDiv) {
              nonFieldErrorDiv.innerHTML = `<span>${data.message || 'Registrasi gagal.'}</span>`;
              nonFieldErrorDiv.classList.remove('hidden');
          }
        }
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
      }

    } catch (error) {
      showToast('Terjadi kesalahan. Coba lagi nanti.', 'error');
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
    }
  });
</script>
{% endblock %}
