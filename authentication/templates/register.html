{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  /* Lavalamp setting */
  .lavalamp-blob {
    position: absolute;
    border-radius: 50%;
    /* Gunakan gradien yang sama */
    background: radial-gradient(circle at 30% 30%, var(--lavalamp-light) 0%, var(--lavalamp-dark) 100%);
    /* Shadow internal untuk dimensi */
    box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.2);
    animation: move-blob 35s infinite alternate ease-in-out; 
    opacity: 0.8; /* Opacity lavalamp */
  }

  .lavalamp-blob-1 { 
    --lavalamp-light: rgba(173, 216, 230, 0.7); 
    --lavalamp-dark: rgba(100, 149, 237, 0.7); 
    width: 550px; height: 550px; 
    top: -250px; left: -250px; 
    animation-duration: 57s;
    animation-delay: -3s;
  }
  .lavalamp-blob-2 { 
    --lavalamp-light: rgba(135, 206, 250, 0.6); 
    --lavalamp-dark: rgba(70, 130, 180, 0.6); 
    width: 450px; height: 450px; 
    bottom: -200px; right: -200px; 
    animation-duration: 51s; 
    animation-delay: -1s;
  }
  .lavalamp-blob-3 { 
    --lavalamp-light: rgba(126, 179, 232, 0.75); 
    --lavalamp-dark: rgba(65, 105, 225, 0.75); 
    width: 380px; height: 380px; 
    top: 55%; left: 45%; 
    transform: translate(-50%,-50%); 
    animation-duration: 50s; 
    animation-delay: -5s;
  }
  .lavalamp-blob-4 { 
    --lavalamp-light: rgba(176, 224, 230, 0.5); 
    --lavalamp-dark: rgba(95, 158, 160, 0.5); 
    width: 300px; height: 300px; 
    top: 15%; left: 60%; 
    animation-duration: 45s; 
    animation-delay: -7s;
  }
  .lavalamp-blob-5 { 
    --lavalamp-light: rgba(119, 136, 153, 0.6); 
    --lavalamp-dark: rgba(72, 61, 139, 0.6); 
    width: 420px; height: 420px; 
    bottom: 5%; left: 15%; 
    animation-duration: 51s; 
    animation-delay: -2s;
  }
  .lavalamp-blob-6 { 
    --lavalamp-light: rgba(0, 191, 255, 0.7); 
    --lavalamp-dark: rgba(30, 144, 255, 0.7); 
    width: 280px; height: 280px; 
    top: 65%; right: 15%; 
    animation-duration: 43s; 
    animation-delay: -4s;
  }
  .lavalamp-blob-7 { 
    --lavalamp-light: rgba(173, 216, 230, 0.65); 
    --lavalamp-dark: rgba(106, 90, 205, 0.65); 
    width: 230px; height: 230px; 
    bottom: 25%; right: 40%; 
    animation-duration: 45s; 
    animation-delay: -6s;
  }
  
  /* Untuk gerakan */
  @keyframes move-blob {
    0% { 
        transform: translate(0,0) scale(1) rotate(0deg); 
        border-radius: 40% 60% 50% 50% / 60% 40% 60% 40%; 
    }
    20% { 
        transform: translate(20vw, -15vh) scale(1.1) rotate(5deg); /* Gerak ke kanan atas */
        border-radius: 50% 50% 60% 40% / 40% 60% 40% 60%; 
    }
    40% { 
        transform: translate(-10vw, 18vh) scale(0.95) rotate(-5deg); /* Gerak ke kiri bawah */
        border-radius: 60% 40% 50% 50% / 60% 40% 60% 40%; 
    }
    60% { 
        transform: translate(5vw, 25vh) scale(1.05) rotate(8deg); /* Gerak ke bawah */
        border-radius: 45% 55% 55% 45% / 55% 45% 55% 45%; 
    }
    80% { 
        transform: translate(-20vw, -10vh) scale(0.9) rotate(-3deg); /* Gerak ke kiri atas */
        border-radius: 55% 45% 45% 55% / 45% 55% 45% 55%; 
    }
    100% { 
        transform: translate(0,0) scale(1) rotate(0deg); 
        border-radius: 40% 60% 50% 50% / 60% 40% 60% 40%; 
    }
  }
</style>

<div class="flex justify-center items-center min-h-[80vh] px-4 py-8">

    <!-- Lavalamp untuk di belakang card -->
    <div class="absolute inset-0 overflow-hidden z-0">
      <div class="lavalamp-blob lavalamp-blob-1"></div>
      <div class="lavalamp-blob lavalamp-blob-2"></div>
      <div class="lavalamp-blob lavalamp-blob-3"></div>
      <div class="lavalamp-blob lavalamp-blob-4"></div>
      <div class="lavalamp-blob lavalamp-blob-5"></div>
      <div class="lavalamp-blob lavalamp-blob-6"></div>
      <div class="lavalamp-blob lavalamp-blob-7"></div>
    </div>

  <div class="bg-white/80 backdrop-blur-lg shadow-xl rounded-2xl p-8 w-full max-w-lg border border-slate-200">

    <!-- Heading -->
    <div class="text-center mb-4">
      <h2 class="text-xl font-semibold text-blue-600">LigaPass</h2>
    </div>

    <h1 class="text-2xl font-bold text-slate-800 mb-6 text-center">Daftar Akun Baru</h1>

    <form id="registerForm" method="POST" class="space-y-4">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
          {% for error in form.non_field_errors %}
            <span class="block sm:inline">{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          {{ form.first_name }}
          {% if form.first_name.errors %}
            <div class="text-red-600 text-xs mt-1">{% for error in form.first_name.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        <div>
          {{ form.last_name }}
          {% if form.last_name.errors %}
            <div class="text-red-600 text-xs mt-1">{% for error in form.last_name.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
      </div>

      <div>
        {{ form.username }}
        {% if form.username.errors %}
          <div class="text-red-600 text-xs mt-1">{% for error in form.username.errors %}{{ error }}{% endfor %}</div>
        {% endif %}
      </div>

      <div>
        {{ form.email }}
        {% if form.email.errors %}
          <div class="text-red-600 text-xs mt-1">{% for error in form.email.errors %}{{ error }}{% endfor %}</div>
        {% endif %}
      </div>

      <!-- Password 1 -->
      <div class="relative">
        {{ form.password1 }}
        <button type="button"
                class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600"
                onclick="togglePasswordVisibility('id_password1', this)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.98 8.223A10.477 10.477 0 001.934 12
            C3.226 16.338 7.244 19.5 12 19.5
            c.993 0 1.953-.138 2.863-.395M6.228 6.228
            A10.45 10.45 0 0112 4.5
            c4.756 0 8.773 3.162 10.065 7.498
            a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3
            m3.228 3.228l3.65 3.65m7.894 7.894L21 21
            m-3.228-3.228l-3.65-3.65
            m0 0a3 3 0 10-4.243-4.243
            m4.242 4.242L9.88 9.88" />
          </svg>
        </button>
      </div>
      {% if form.password1.errors %}
        <div class="text-red-600 text-xs -mt-3">
          {% for error in form.password1.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}

      <!-- Password 2 -->
      <div class="relative">
        {{ form.password2 }}
        <button type="button"
                class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600"
                onclick="togglePasswordVisibility('id_password2', this)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.98 8.223A10.477 10.477 0 001.934 12
            C3.226 16.338 7.244 19.5 12 19.5
            c.993 0 1.953-.138 2.863-.395M6.228 6.228
            A10.45 10.45 0 0112 4.5
            c4.756 0 8.773 3.162 10.065 7.498
            a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3
            m3.228 3.228l3.65 3.65m7.894 7.894L21 21
            m-3.228-3.228l-3.65-3.65
            m0 0a3 3 0 10-4.243-4.243
            m4.242 4.242L9.88 9.88" />
          </svg>
        </button>
      </div>
      {% if form.password2.errors %}
        <div class="text-red-600 text-xs -mt-3">
          {% for error in form.password2.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}

      <button type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out mt-6">
        Daftar Sekarang
      </button>
    </form>

    <div class="text-center mt-6 text-sm">
      <p class="text-slate-600">
        Udah punya akun?
        <a href="{% url 'authentication:login' %}" class="text-blue-600 hover:text-blue-700 font-semibold underline hover:no-underline transition">
          Masuk di sini
        </a>
      </p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const formInputs = document.querySelectorAll('#registerForm input');
    const placeholders = {
        'id_first_name': 'Nama Depan',
        'id_last_name': 'Nama Belakang',
        'id_username': 'Username',
        'id_email': 'Alamat Email Aktif',
        'id_password1': 'Buat Password',
        'id_password2': 'Ulangi Password'
    };
    const commonClasses = 'w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out placeholder-slate-400';
    const passwordClasses = 'pr-10';

    formInputs.forEach(input => {
      if (input.type === 'hidden') return;
      input.classList.add(...commonClasses.split(' '));
      if (placeholders[input.id]) input.setAttribute('placeholder', placeholders[input.id]);
      if (input.type === 'password' || input.id.includes('password'))
        input.classList.add(passwordClasses);
    });
  });

  // --- Fungsi Toggle Password ---
  function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const iconOpen = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`;
    const iconClosed = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/></svg>`;

    if (input.type === "password") {
      input.type = "text";
      button.innerHTML = iconOpen;
    } else {
      input.type = "password";
      button.innerHTML = iconClosed;
    }
  }

  const registerForm = document.getElementById('registerForm');
  registerForm.addEventListener('submit', async function(event) {
    event.preventDefault();

    const submitButton = registerForm.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Processing...`;

    // Hapus pesan error lama
    registerForm.querySelectorAll('.text-red-600').forEach(el => el.textContent = '');
    const nonFieldErrorDiv = registerForm.querySelector('.bg-red-100');
    if (nonFieldErrorDiv) nonFieldErrorDiv.classList.add('hidden');

    const formData = new FormData(registerForm);
    const csrfToken = formData.get('csrfmiddlewaretoken');

    try {
      const response = await fetch(registerForm.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      });

      const data = await response.json()

      if (response.ok && data.status === 'success') {
        showToast(data.message || 'Registrasi berhasil!', 'success');
        setTimeout(() => {
          window.location.href = data.redirect_url;
        }, 1000);

      } else {
  
        if (data.errors) {
          for (const fieldName in data.errors) {
            const errorDiv = registerForm.querySelector(`#id_${fieldName}`)?.closest('div')?.querySelector('.text-red-600');
            if (errorDiv) {
              errorDiv.textContent = data.errors[fieldName].join(' ');
            }
            if (fieldName === '__all__' && nonFieldErrorDiv) {
              nonFieldErrorDiv.innerHTML = data.errors[fieldName].map(err => `<span>${err}</span>`).join('<br>');
              nonFieldErrorDiv.classList.remove('hidden');
            }
          }
           if(data.errors.__all__){
               showToast(data.errors.__all__.join(' '), 'error');
           } else {
               showToast('Periksa kembali isian form Anda.', 'warning');
           }
        } else {
          showToast(data.message || 'Registrasi gagal.', 'error');
          if (nonFieldErrorDiv) {
              nonFieldErrorDiv.innerHTML = `<span>${data.message || 'Registrasi gagal.'}</span>`;
              nonFieldErrorDiv.classList.remove('hidden');
          }
        }
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
      }

    } catch (error) {
      console.error('Registration error:', error);
      showToast('Terjadi kesalahan. Coba lagi nanti.', 'error');
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
    }
  });
</script>
{% endblock %}
