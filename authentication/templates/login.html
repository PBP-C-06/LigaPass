{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="flex justify-center items-center min-h-[80vh] px-4 py-8">
  <div class="bg-white/80 backdrop-blur-lg shadow-xl rounded-2xl p-8 w-full max-w-md border border-slate-200">
    <div class="text-center mb-4">
      <h2 class="text-xl font-semibold text-blue-600">LigaPass</h2>
    </div>
    <h1 class="text-2xl font-bold text-slate-800 mb-6 text-center">Login ke Akun Anda</h1>

    <form id="login-form" method="POST" class="space-y-4">
      {% csrf_token %}
      <div>
        <label for="id_username" class="block text-slate-700 text-sm font-semibold mb-1">Username</label>
        <input id="id_username" name="username" type="text"
               class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400 transition"
               placeholder="Masukkan username kamu" required>
         <div id="username-error-ajax" class="text-red-600 text-xs mt-1"></div>
      </div>

      <div class="relative">
        <label for="id_password" class="block text-slate-700 text-sm font-semibold mb-1">Password</label>
        <input id="id_password" name="password" type="password"
               class="w-full px-4 py-2 pr-10 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400 transition"
               placeholder="Masukkan password" required>
        <button type="button"
                class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600 focus:outline-none"
                onclick="togglePasswordVisibility('id_password', this)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
               stroke-width="1.5" stroke="currentColor" class="w-5 h-5 toggle-icon">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M2.036 12.322a1.012 1.012 0 010-.639
                     C3.423 7.51 7.36 4.5 12 4.5
                     c4.638 0 8.573 3.007 9.963 7.178
                     .07.207.07.431 0 .639
                     C20.577 16.49 16.64 19.5 12 19.5
                     c-4.638 0-8.573-3.007-9.963-7.178z" />
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>
      <div id="password-error-ajax" class="text-red-600 text-xs -mt-3"></div>
      <div id="non-field-error-ajax" class="text-red-600 text-xs text-center"></div>

      <div class="flex justify-between items-center text-sm mt-3">
        <a href="{% url 'authentication:register' %}" class="text-blue-600 hover:underline font-medium transition">Belum punya akun?</a>
        <a href="{% url 'password_reset' %}" class="text-slate-500 hover:underline font-medium transition">Lupa password?</a>
      </div>

      <button id="login-submit" type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg mt-5 shadow-md hover:shadow-lg transition duration-200 ease-in-out">
        Login
      </button>
    </form>

    <div class="my-6 flex items-center justify-center">
      <span class="border-b border-slate-300 w-1/5 lg:w-1/4"></span>
      <span class="text-xs text-center text-slate-500 uppercase mx-4">atau</span>
      <span class="border-b border-slate-300 w-1/5 lg:w-1/4"></span>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <div class="flex justify-center mt-2">
      <div id="googleBtn"></div>
    </div>
  </div>
</div>

<form id="google-post-form" method="POST" action="{% url 'authentication:google_login' %}" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="credential" id="google-credential-input">
</form>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
  /* ===== Password Toggle Fix ===== */
  function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const svg = button.querySelector("svg");

    const openIcon = `
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M2.036 12.322a1.012 1.012 0 010-.639
               C3.423 7.51 7.36 4.5 12 4.5
               c4.638 0 8.573 3.007 9.963 7.178
               .07.207.07.431 0 .639
               C20.577 16.49 16.64 19.5 12 19.5
               c-4.638 0-8.573-3.007-9.963-7.178z" />
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>`;

    const closedIcon = `
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.98 8.223A10.477 10.477 0 001.934 12
               C3.226 16.338 7.244 19.5 12 19.5
               c.993 0 1.953-.138 2.863-.395
               M6.228 6.228A10.45 10.45 0 0112 4.5
               c4.756 0 8.773 3.162 10.065 7.498
               a10.523 10.523 0 01-4.293 5.774
               M6.228 6.228L3 3m3.228 3.228l3.65 3.65
               m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65
               m0 0a3 3 0 10-4.243-4.243
               m4.242 4.242L9.88 9.88"/>`;

    if (input.type === "password") {
      input.type = "text";
      svg.innerHTML = closedIcon;
    } else {
      input.type = "password";
      svg.innerHTML = openIcon;
    }
  }

  /* ===== Utility: Get CSRF Cookie ===== */
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      for (const c of document.cookie.split(';')) {
        const s = c.trim();
        if (s.substring(0, name.length + 1) === (name + '=')) {
          v = decodeURIComponent(s.substring(name.length + 1)); break;
        }
      }
    }
    return v;
  }

  /* ===== AJAX Login ===== */
  document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('login-submit');
    btn.disabled = true;
    try {
      const res = await fetch("{% url 'authentication:login' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Accept': 'application/json' },
        body: new URLSearchParams(new FormData(this)),
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.status === 'success' && data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        const errorMsg = data.message || JSON.stringify(data.errors || 'Login gagal.');
        alert(errorMsg);
      }
    } catch (err) {
      console.error(err);
      alert('Error saat login.');
    } finally {
      btn.disabled = false;
    }
  });

  /* ===== Google Sign-In (POPUP) ===== */
  async function onGoogleCredential(resp) {
    if (!resp || !resp.credential) {
      console.error('No credential from Google');
      return;
    }

    const formData = new FormData();
    formData.append('credential', resp.credential);

    try {
      const res = await fetch("{% url 'authentication:google_login' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Accept': 'application/json' },
        body: formData,
      });
      const data = await res.json();
      if (res.ok && data.status === 'success' && data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        alert(data.message || 'Google login gagal.');
      }
    } catch (err) {
      console.error(err);
      alert('Error saat login dengan Google.');
    }
  }

  window.onGoogleCredential = onGoogleCredential;

  window.addEventListener('load', function () {
    if (!window.google || !google.accounts?.id) {
      console.error('GIS SDK not loaded');
      return;
    }
    google.accounts.id.initialize({
      client_id: "{{ GOOGLE_CLIENT_ID }}",
      ux_mode: "popup",
      callback: onGoogleCredential,
      auto_select: false,
    });
    google.accounts.id.renderButton(
      document.getElementById("googleBtn"),
      { theme: "outline", size: "large", width: 280, text: "signin_with" }
    );
  });
</script>
{% endblock %}
