{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  /* Lavalamp setting */
  .lavalamp-blob {
    position: absolute;
    border-radius: 50%;
    /* Gunakan gradien yang sama */
    background: radial-gradient(circle at 30% 30%, var(--lavalamp-light) 0%, var(--lavalamp-dark) 100%);
    /* Shadow internal untuk dimensi */
    box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.2);
    animation: move-blob 35s infinite alternate ease-in-out; 
    opacity: 0.8; /* Opacity lavalamp */
  }

  .lavalamp-blob-1 { 
    --lavalamp-light: rgba(173, 216, 230, 0.7); 
    --lavalamp-dark: rgba(100, 149, 237, 0.7); 
    width: 550px; height: 550px; 
    top: -250px; left: -250px; 
    animation-duration: 57s;
    animation-delay: -3s;
  }
  .lavalamp-blob-2 { 
    --lavalamp-light: rgba(135, 206, 250, 0.6); 
    --lavalamp-dark: rgba(70, 130, 180, 0.6); 
    width: 450px; height: 450px; 
    bottom: -200px; right: -200px; 
    animation-duration: 51s; 
    animation-delay: -1s;
  }
  .lavalamp-blob-3 { 
    --lavalamp-light: rgba(126, 179, 232, 0.75); 
    --lavalamp-dark: rgba(65, 105, 225, 0.75); 
    width: 380px; height: 380px; 
    top: 55%; left: 45%; 
    transform: translate(-50%,-50%); 
    animation-duration: 50s; 
    animation-delay: -5s;
  }
  .lavalamp-blob-4 { 
    --lavalamp-light: rgba(176, 224, 230, 0.5); 
    --lavalamp-dark: rgba(95, 158, 160, 0.5); 
    width: 300px; height: 300px; 
    top: 15%; left: 60%; 
    animation-duration: 45s; 
    animation-delay: -7s;
  }
  .lavalamp-blob-5 { 
    --lavalamp-light: rgba(119, 136, 153, 0.6); 
    --lavalamp-dark: rgba(72, 61, 139, 0.6); 
    width: 420px; height: 420px; 
    bottom: 5%; left: 15%; 
    animation-duration: 51s; 
    animation-delay: -2s;
  }
  .lavalamp-blob-6 { 
    --lavalamp-light: rgba(0, 191, 255, 0.7); 
    --lavalamp-dark: rgba(30, 144, 255, 0.7); 
    width: 280px; height: 280px; 
    top: 65%; right: 15%; 
    animation-duration: 43s; 
    animation-delay: -4s;
  }
  .lavalamp-blob-7 { 
    --lavalamp-light: rgba(173, 216, 230, 0.65); 
    --lavalamp-dark: rgba(106, 90, 205, 0.65); 
    width: 230px; height: 230px; 
    bottom: 25%; right: 40%; 
    animation-duration: 45s; 
    animation-delay: -6s;
  }
  
  /* Untuk gerakan */
  @keyframes move-blob {
    0% { 
        transform: translate(0,0) scale(1) rotate(0deg); 
        border-radius: 40% 60% 50% 50% / 60% 40% 60% 40%; 
    }
    20% { 
        transform: translate(20vw, -15vh) scale(1.1) rotate(5deg); /* Gerak ke kanan atas */
        border-radius: 50% 50% 60% 40% / 40% 60% 40% 60%; 
    }
    40% { 
        transform: translate(-10vw, 18vh) scale(0.95) rotate(-5deg); /* Gerak ke kiri bawah */
        border-radius: 60% 40% 50% 50% / 60% 40% 60% 40%; 
    }
    60% { 
        transform: translate(5vw, 25vh) scale(1.05) rotate(8deg); /* Gerak ke bawah */
        border-radius: 45% 55% 55% 45% / 55% 45% 55% 45%; 
    }
    80% { 
        transform: translate(-20vw, -10vh) scale(0.9) rotate(-3deg); /* Gerak ke kiri atas */
        border-radius: 55% 45% 45% 55% / 45% 55% 45% 55%; 
    }
    100% { 
        transform: translate(0,0) scale(1) rotate(0deg); 
        border-radius: 40% 60% 50% 50% / 60% 40% 60% 40%; 
    }
  }
</style>

<div class="flex justify-center items-center min-h-[80vh] px-4 py-8">

    <!-- Lavalamp untuk di belakang card -->
    <div class="absolute inset-0 overflow-hidden z-0">
      <div class="lavalamp-blob lavalamp-blob-1"></div>
      <div class="lavalamp-blob lavalamp-blob-2"></div>
      <div class="lavalamp-blob lavalamp-blob-3"></div>
      <div class="lavalamp-blob lavalamp-blob-4"></div>
      <div class="lavalamp-blob lavalamp-blob-5"></div>
      <div class="lavalamp-blob lavalamp-blob-6"></div>
      <div class="lavalamp-blob lavalamp-blob-7"></div>
    </div>

  <div class="bg-white/80 backdrop-blur-lg shadow-xl rounded-2xl p-8 w-full max-w-md border border-slate-200">
    <div class="text-center mb-4">
      <h2 class="text-xl font-semibold text-blue-600">LigaPass</h2>
    </div>

    <h1 class="text-2xl font-bold text-slate-800 mb-6 text-center">Login ke Akun Anda</h1>
    <form id="login-form" method="POST" class="space-y-4">
      {% csrf_token %}

      <!-- Username -->
      <div>
        <label for="id_username" class="block text-slate-700 text-sm font-semibold mb-1">Username</label>
        <input
          id="id_username"
          name="username"
          type="text"
          class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400 transition"
          placeholder="Masukkan username kamu"
          required
        />
        <div id="username-error-ajax" class="text-red-600 text-xs mt-1"></div>
      </div>

      <!-- Password -->
      <div>
        <label for="id_password" class="block text-slate-700 text-sm font-semibold mb-1">Password</label>
        <div class="relative">
          <input
            id="id_password"
            name="password"
            type="password"
            class="w-full px-4 py-2 pr-12 h-11 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400 transition"
            placeholder="Masukkan password"
            required
          />

          <button
            type="button"
            class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600 focus:outline-none"
            aria-label="Toggle password visibility"
            onclick="togglePasswordVisibility('id_password', this)"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
              stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3.98 8.223A10.477 10.477 0 001.934 12
              C3.226 16.338 7.244 19.5 12 19.5
              c.993 0 1.953-.138 2.863-.395M6.228 6.228
              A10.45 10.45 0 0112 4.5
              c4.756 0 8.773 3.162 10.065 7.498
              a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3
              m3.228 3.228l3.65 3.65m7.894 7.894L21 21
              m-3.228-3.228l-3.65-3.65
              m0 0a3 3 0 10-4.243-4.243
              m4.242 4.242L9.88 9.88" />
            </svg>
          </button>
        </div>
      </div>

      <div id="password-error-ajax" class="text-red-600 text-xs -mt-3"></div>
      <div id="non-field-error-ajax" class="text-red-600 text-xs text-center"></div>

      <div class="flex justify-between items-center text-sm mt-1">
        <a href="{% url 'authentication:register' %}" class="text-blue-600 hover:underline font-medium transition">Belum punya akun?</a>
        <a href="{% url 'password_reset' %}" class="text-slate-500 hover:underline font-medium transition">Lupa password?</a>
      </div>

      <button
        id="login-submit"
        type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg mt-5 shadow-md hover:shadow-lg transition duration-200 ease-in-out"
      >
        Login
      </button>
    </form>

    <div id="suspendModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md text-center">
        <h3 class="text-lg font-semibold text-yellow-600 mb-2">⚠️ Akun Ditangguhkan</h3>
        <p class="text-slate-700 text-sm mb-4">
          Akun Anda sedang ditangguhkan sementara. Beberapa fitur (seperti komentar dan posting) tidak dapat digunakan hingga akun diaktifkan kembali.
        </p>
        <button id="closeModalBtn"
                class="px-5 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-medium rounded-lg transition">
          Saya Mengerti
        </button>
      </div>
    </div>

    <div class="my-6 flex items-center justify-center">
      <span class="border-b border-slate-300 w-1/5 lg:w-1/4"></span>
      <span class="text-xs text-center text-slate-500 uppercase mx-4">atau</span>
      <span class="border-b border-slate-300 w-1/5 lg:w-1/4"></span>
    </div>

    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <div class="flex justify-center mt-2">
      <div id="googleBtn"></div>
    </div>
  </div>
</div>

<!-- Fallback form (kalau mau post non-AJAX) -->
<form id="google-post-form" method="POST" action="{% url 'authentication:google_login' %}" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="credential" id="google-credential-input">
</form>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
  // ===== Toggle password =====
  function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const iconOpen = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`;
    const iconClosed = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/></svg>`;

    if (input.type === "password") {
      input.type = "text";
      button.innerHTML = iconOpen;
    } else {
      input.type = "password";
      button.innerHTML = iconClosed;
    }
  }

  // ===== Ambil CSRF cookie =====
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      for (const c of document.cookie.split(';')) {
        const s = c.trim();
        if (s.startsWith(name + '=')) {
          v = decodeURIComponent(s.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }

  // ===== AJAX Login =====
  document.getElementById('login-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = document.getElementById('login-submit');
    btn.disabled = true;

    try {
      const res = await fetch("{% url 'authentication:login' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Accept': 'application/json'
        },
        body: new URLSearchParams(new FormData(this)),
      });

      const data = await res.json().catch(() => ({}));

      if (res.ok && data.status === 'success' && data.redirect_url) {
        showToast('✅ Login berhasil! Mengarahkan...', 'success');
        setTimeout(() => window.location.href = data.redirect_url, 1000);
      } else {
        showToast('❌ ' + (data.message || 'Login gagal. Cek username/password!'), 'error');
      }
    } catch {
      showToast('⚠️ Terjadi kesalahan koneksi.', 'error');
    } finally {
      btn.disabled = false;
    }
  });

  // ===== Google Sign-In =====
  window.onload = function() {
    if (!window.google || !google.accounts?.id) return;
    google.accounts.id.initialize({
      client_id: "{{ GOOGLE_CLIENT_ID }}",
      ux_mode: "popup",
      callback: async (resp) => {
        const formData = new FormData();
        formData.append('credential', resp.credential);

        try {
          const res = await fetch("{% url 'authentication:google_login' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Accept': 'application/json'
            },
            body: formData,
          });

          const data = await res.json();
          if (res.ok && data.status === 'success' && data.redirect_url) {
            showToast('✅ Login Google berhasil! Mengarahkan...', 'success');
            setTimeout(() => window.location.href = data.redirect_url, 1000);
          } else {
            showToast('❌ ' + (data.message || 'Login Google gagal.'), 'error');
          }
        } catch {
          showToast('⚠️ Error saat login Google.', 'error');
        }
      }
    });
    google.accounts.id.renderButton(
      document.getElementById("googleBtn"),
      { theme: "outline", size: "large", width: 280, text: "signin_with" }
    );
  }

  function showSuspendModal() {
    const modal = document.getElementById('suspendModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('closeModalBtn').addEventListener('click', () => {
      modal.classList.add('hidden');
    });
  }

  // ===== Integrasi ke login AJAX =====
  if (res.ok && data.status === 'success' && data.redirect_url) {
    if (data.profile_status === 'suspended') {
      showSuspendModal();
      showToast('⚠️ Akun Anda sedang ditangguhkan.', 'warning');
      setTimeout(() => window.location.href = data.redirect_url, 2500);
    } else {
      showToast('✅ Login berhasil! Mengarahkan...', 'success');
      setTimeout(() => window.location.href = data.redirect_url, 1000);
    }
  } else if (data.status === 'banned') {
    showToast('🚫 Akun Anda diblokir. Hubungi admin di l1gapass@outlook.com.', 'error');
  }
</script>
{% endblock %}