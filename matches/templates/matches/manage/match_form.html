{% extends 'base.html' %}
{% block title %}Manajemen Pertandingan - {% if is_update %}Edit{% else %}Tambah{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-slate-800 p-8 rounded-lg shadow-xl">
  <h1 class="text-3xl font-bold mb-6 text-white">
    {% if is_update %}
      Edit Pertandingan: {{ object.home_team.name|default:'N/A' }} vs {{ object.away_team.name|default:'N/A' }}
    {% else %}
      Tambah Pertandingan Baru
    {% endif %}
  </h1>

  <form method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}

    <h2 class="text-xl font-semibold text-blue-400 border-b border-slate-700 pb-2">
      Detail Pertandingan
    </h2>

    {% if form.non_field_errors %}
      <div class="bg-red-900 text-red-100 p-3 rounded">
        {% for error in form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}

    {% for field in form %}
      <div class="field-wrapper">
        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-slate-300 mb-1">
          {{ field.label }}
        </label>
        {{ field }}
        {% if field.help_text %}
          <p class="text-xs text-slate-400 mt-1">{{ field.help_text }}</p>
        {% endif %}
        {% for error in field.errors %}
          <p class="text-xs text-red-400 mt-1">{{ error }}</p>
        {% endfor %}
      </div>
    {% endfor %}

    <h2 class="text-xl font-semibold text-blue-400 border-b border-slate-700 pb-2 pt-4">
      Harga Tiket
    </h2>

    {{ formset.management_form }}

    {% if formset.non_form_errors %}
      <div class="bg-red-900 text-red-100 p-3 rounded">
        {% for error in formset.non_form_errors %}
          <p>Error Formset: {{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <div id="ticket-price-formset" class="space-y-4">
      {% for ticket_form in formset %}
        <div class="ticket-price-form p-4 border border-slate-700 rounded-lg space-y-2 relative bg-slate-700/40 transition-all">
          <button type="button" class="delete-ticket absolute top-2 right-3 text-red-400 hover:text-red-300 text-sm font-semibold">
            ✕
          </button>

          <p class="text-sm font-medium text-white">Kategori #{{ forloop.counter }}</p>

          {% if ticket_form.non_field_errors %}
            <div class="bg-red-900 text-red-100 p-2 rounded">
              {% for error in ticket_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            {% for field in ticket_form.visible_fields %}
              {% if field.name != 'DELETE' %}
                <div class="field-wrapper">
                  <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-slate-300 mb-1">
                    {{ field.label }}
                  </label>
                  {{ field }}
                  {% for error in field.errors %}
                    <p class="text-xs text-red-400 mt-1">{{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>

          {{ ticket_form.DELETE }}
        </div>
      {% endfor %}
    </div>

    <div id="empty-form-template" class="hidden">
      <div class="ticket-price-form p-4 border border-slate-700 rounded-lg space-y-2 relative bg-slate-700/40 transition-all">
        <button type="button" class="delete-ticket absolute top-2 right-3 text-red-400 hover:text-red-300 text-sm font-semibold">
          ✕
        </button>

        <p class="text-sm font-medium text-white">Kategori #__prefix__</p>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          {% for field in formset.empty_form.visible_fields %}
            {% if field.name != 'DELETE' %}
              <div class="field-wrapper">
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-slate-300 mb-1">
                  {{ field.label }}
                </label>
                {{ field }}
              </div>
            {% endif %}
          {% endfor %}
        </div>

        {{ formset.empty_form.DELETE }}
      </div>
    </div>

    <div class="flex justify-end mt-3">
      <button type="button" id="add-ticket-row" class="bg-slate-700 hover:bg-slate-600 text-blue-400 hover:text-blue-300 font-medium py-2 px-4 rounded-lg transition-colors border border-slate-600">
        + Tambah Kategori
      </button>
    </div>

    <style>
      .field-wrapper input,
      .field-wrapper textarea,
      .field-wrapper select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        background-color: #334155;
        border: 1px solid #475569;
        color: white;
        transition: border-color 0.2s;
      }
      .field-wrapper input:focus,
      .field-wrapper textarea:focus,
      .field-wrapper select:focus {
        border-color: #3b82f6;
        outline: none;
      }
    </style>

    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors mt-6">
      {% if is_update %}Perbarui Pertandingan{% else %}Simpan Pertandingan{% endif %}
    </button>
  </form>

  <div class="mt-4 text-center">
    <a href="{% url 'matches:manage_matches' %}" class="text-slate-400 hover:text-slate-300 text-sm">
      Kembali ke Daftar Pertandingan
    </a>
  </div>
</div>

<script>
// Fungsi untuk memperbarui nomor urut kategori
function updateCategoryNumbers() {
  const formsetDiv = document.getElementById('ticket-price-formset');
  if (!formsetDiv) return;

  let counter = 1;
  
  formsetDiv.querySelectorAll('.ticket-price-form').forEach((form) => {
    if (form.style.display !== 'none') {
      const label = form.querySelector('p.text-sm.font-medium.text-white');
      if (label) {
        label.textContent = `Kategori #${counter}`;
        counter++;
      }
    }
  });
}

// Fungsi utama untuk menambah form baru
function addTicketForm(event) {
  event.preventDefault();
  
  // FIX KRITIS: Menggunakan ID yang benar dari log error Anda.
  const formsetDiv = document.getElementById('ticket-price-formset');
  const totalForms = document.getElementById('id_ticket_prices-TOTAL_FORMS'); // <--- PERUBAHAN DI SINI!
  const emptyTemplate = document.getElementById('empty-form-template');

  if (!totalForms || !formsetDiv || !emptyTemplate) {
    console.error('FATAL ERROR: Elemen formset management atau container/template tidak ditemukan.');
    return;
  }

  try {
    const currentCount = parseInt(totalForms.value);
    
    const emptyTemplateHtml = emptyTemplate.innerHTML;
    
    // Ganti placeholder __prefix__ dengan index baru
    let newHtml = emptyTemplateHtml.replace(/__prefix__/g, currentCount);
    
    // Karena formset management form di-render menggunakan prefix: 'ticket_prices'
    // Kita juga harus mengganti '__prefix__' di dalam HTML template input.
    // Pastikan template HTML juga menggunakan prefix yang benar untuk input name/id jika ada hardcode
    
    // 3. Konversi string HTML menjadi elemen DOM
    const temp = document.createElement('div');
    temp.innerHTML = newHtml.trim();
    const newForm = temp.firstElementChild;

    // 4. Reset nilai input/select/textarea pada form baru
    newForm.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
      else el.value = '';
    });

    // 5. Tambahkan ke DOM dan update total
    formsetDiv.appendChild(newForm);
    totalForms.value = currentCount + 1; // Increment TOTAL_FORMS
    
    updateCategoryNumbers();
    
  } catch (error) {
    console.error('Error saat menambahkan kategori baru:', error);
    alert('Terjadi kesalahan saat menambah kategori.');
  }
}

// Fungsi untuk menangani penghapusan form
function deleteTicketForm(e) {
  if (e.target.classList.contains('delete-ticket')) {
    e.preventDefault();
    const form = e.target.closest('.ticket-price-form');
    
    // Name attribute untuk DELETE harus dicari dengan benar
    const deleteInput = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
    
    if (deleteInput) {
      deleteInput.checked = true;
      form.style.display = 'none';
      updateCategoryNumbers();
    }
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const addButton = document.getElementById('add-ticket-row');
  const formsetDiv = document.getElementById('ticket-price-formset');
  
  if (addButton) {
    addButton.addEventListener('click', addTicketForm);
  }
  
  if (formsetDiv) {
    formsetDiv.addEventListener('click', deleteTicketForm);
  }
  
  updateCategoryNumbers();
});
</script>
{% endblock %}