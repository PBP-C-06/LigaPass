{% extends 'base.html' %}
{% block title %}Detail Pertandingan{% endblock %}
{% block content %}
<div class="bg-slate-800 max-w-4xl mx-auto p-6 rounded-lg shadow-lg">
    <div class="text-center mb-6">
        <p class="text-slate-400">{{ match.date|date:"l, d F Y - H:i" }} WIB</p>
        <p class="text-lg text-slate-300">{{ match.venue.name }}, {{ match.venue.city }}</p>
    </div>
    <div class="flex justify-around items-center">
        <div class="text-center w-1/3">
            <img src="{{ match.home_team.display_logo_url }}" alt="{{ match.home_team.name }}" class="w-24 h-24 mx-auto mb-2">
            <h2 class="text-2xl font-bold">{{ match.home_team.name }}</h2>
        </div>
        <div class="text-center">
            <p id="score-display" class="text-5xl font-bold">{{ match.home_goals|default_if_none:"-" }} - {{ match.away_goals|default_if_none:"-" }}</p>
            <div id="status-container" class="mt-2">
                {% if match.status_key == 'Past' %}
                    <span id="status-badge" class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded">Finished</span>
                {% elif match.status_key == 'Ongoing' %}
                    <span id="status-badge" class="bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded animate-pulse">LIVE</span>
                {% else %}
                    <span id="status-badge" class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded">Upcoming</span>
                {% endif %}
            </div>
        </div>
        <div class="text-center w-1/3">
            <img src="{{ match.away_team.display_logo_url }}" alt="{{ match.away_team.name }}" class="w-24 h-24 mx-auto mb-2">
            <h2 class="text-2xl font-bold">{{ match.away_team.name }}</h2>
        </div>
    </div>
    {% if match.status_key == 'Upcoming' and ticket_prices %}
    <div class="mt-8 border-t border-slate-600 pt-6">
        <h3 class="text-xl font-bold text-center mb-4">Kategori & Harga Tiket</h3>
        <ul class="max-w-md mx-auto">
            {% for ticket in ticket_prices %}
            <li class="flex justify-between items-center bg-slate-700 p-3 rounded-lg mb-2">
                <span class="font-semibold">{{ ticket.get_seat_category_display }}</span>
                <span class="text-green-400">Rp {{ ticket.price|floatformat:0 }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <div class="mt-8 text-center">
        {% if match.status_key == 'Upcoming' %}
            {% if user.is_authenticated %}
                <a href="{% url 'bookings:create_booking' match.id %}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors">Beli Tiket</a>
            {% else %}
                <a href="{% url 'authentication:login' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors">Login untuk Membeli Tiket</a>
            {% endif %}
        {% elif match.status_key == 'Ongoing' %}
            <button disabled class="bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg text-lg cursor-not-allowed">Match is underway</button>
        {% else %}
            <button disabled class="bg-slate-600 text-slate-400 font-bold py-3 px-8 rounded-lg text-lg cursor-not-allowed">Match has finished</button>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
{% if match.status_key == 'Ongoing' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const matchId = "{{ match.api_id }}";
    const scoreDisplay = document.getElementById('score-display');
    const statusContainer = document.getElementById('status-container');

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/match/' + matchId + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        // Update skor
        scoreDisplay.textContent = `${data.home_goals ?? '-'} - ${data.away_goals ?? '-'}`;
        
        // Update status badge
        let statusBadgeHTML = '';
        if (data.status_short === "FT") {
            statusBadgeHTML = `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded">Finished</span>`;
            chatSocket.close(); // Tutup koneksi jika match selesai
            location.reload(); // Refresh halaman agar tombol berubah
        } else {
            statusBadgeHTML = `<span class="bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded animate-pulse">${data.elapsed ?? 'LIVE'}'</span>`;
        }
        statusContainer.innerHTML = statusBadgeHTML;
    };

    chatSocket.onopen = function(e) {
        console.log('WebSocket terhubung untuk live score.');
    };

    chatSocket.onclose = function(e) {
        console.error('WebSocket terputus.');
    };
});
</script>
{% endif %}
{% endblock %}