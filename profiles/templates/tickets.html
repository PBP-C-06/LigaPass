{% extends "components/base_profiles.html" %}
{% load static %}

{% block profile_content %}
<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
  <h2 class="text-2xl font-bold text-gray-900 mb-3">Tiket Saya</h2>
  <p class="text-gray-500 mb-8">Berikut tiket digital Anda untuk pertandingan yang telah dikonfirmasi.</p>

  <div id="tickets-container" class="space-y-8">
    <div id="tickets-loading" class="text-gray-500">Memuat tiket...</div>
  </div>
</div>

<template id="ticket-card-template">
  <div>
    <!-- FRAME TIKET -->
    <div class="ticket-card flex flex-col md:flex-row bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition overflow-hidden">
      <!-- Kiri: Logo tim -->
      <div class="flex flex-col items-center justify-center bg-gradient-to-b from-gray-50 to-white md:w-1/4 py-6 border-b md:border-b-0 md:border-r relative">
        <div class="flex items-center justify-center space-x-4 mb-2">
          <!-- HOME -->
          <div class="text-center">
            <img class="home-logo h-14 w-14 object-contain mx-auto" src="{% static 'images/default-team.png' %}" alt="Home Logo">
            <p class="text-xs text-gray-500 mt-1">Home</p>
          </div>

          <!-- VS -->
          <div class="relative flex flex-col items-center justify-center">
            <span class="text-gray-500 text-sm font-semibold relative -top-2">vs</span>
          </div>

          <!-- AWAY -->
          <div class="text-center">
            <img class="away-logo h-14 w-14 object-contain mx-auto" src="{% static 'images/default-team.png' %}" alt="Away Logo">
            <p class="text-xs text-gray-500 mt-1">Away</p>
          </div>
        </div>

        <!-- Garis potong -->
        <div class="absolute right-0 top-0 bottom-0 w-[1px] border-dashed border-gray-300"></div>
      </div>

      <!-- Kanan: Info tiket -->
      <div class="flex-1 p-5 flex flex-col justify-between">
        <div>
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-lg font-semibold text-gray-900 match-title">Match Title</h3>
            <span class="status-badge text-xs font-semibold px-2.5 py-1 rounded-full"></span>
          </div>

          <p class="text-sm text-gray-500 match-meta">Venue â€¢ Date</p>
          <p class="mt-1 text-sm text-gray-700"><strong>Kategori:</strong> <span class="seat-category"></span></p>
        </div>

        <div class="mt-4">
          <svg class="barcode w-full h-12" jsbarcode-format="CODE128"></svg>
        </div>
      </div>
    </div>

    <!-- ðŸ†• Tombol di luar frame tiket -->
    <div class="mt-3 flex flex-col sm:flex-row sm:space-x-3 space-y-2 sm:space-y-0">
      <button class="download-btn flex-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2.5 rounded-lg shadow-sm transition">
        Download Tiket
      </button>
      <button class="review-btn hidden flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-sm font-semibold py-2.5 rounded-lg shadow-sm transition">
        Beri Review
      </button>
    </div>
  </div>
</template>

<!-- Modal Review -->
<div id="review-modal" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 text-center relative">
    <h3 class="text-xl font-bold text-gray-900 mb-1">Beri Ulasan Anda</h3>
    <p class="text-gray-500 mb-5">Bagaimana pengalaman menonton pertandingan ini?</p>

    <div class="flex justify-center space-x-2 mb-5" id="rating-stars">
      {% for i in "12345" %}
      <svg data-value="{{ forloop.counter }}" xmlns="http://www.w3.org/2000/svg"
           class="h-8 w-8 star text-gray-300 cursor-pointer transition hover:scale-110"
           fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 .587l3.668 7.568L24 9.753l-6 5.853L19.335 24 12 19.897 4.665 24 6 15.606 0 9.753l8.332-1.598z"/>
      </svg>
      {% endfor %}
    </div>

    <textarea id="review-text" rows="4" placeholder="Tulis pengalaman Anda..."
              class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 mb-6"></textarea>

    <div class="flex justify-center space-x-4">
      <button id="cancel-review"
              class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-semibold py-2 px-5 rounded-lg transition">Batal</button>
      <button id="submit-review"
              class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition">Kirim</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const url = "{% url 'profiles:user_tickets_json' request.user.id %}";
  const container = document.getElementById("tickets-container");
  const loading = document.getElementById("tickets-loading");

  fetch(url)
    .then(res => res.json())
    .then(data => {
      loading.remove();
      const tickets = data.tickets || [];
      if (!tickets.length) {
        container.innerHTML = `<p class='text-gray-600'>Belum ada tiket aktif.</p>`;
        return;
      }

      const tpl = document.getElementById("ticket-card-template");
      tickets.forEach(t => {
        const node = tpl.content.cloneNode(true);
        const card = node.querySelector(".ticket-card");

        // Logo klub
        const homeLogo = card.querySelector(".home-logo");
        const awayLogo = card.querySelector(".away-logo");
        if (t.home_logo) homeLogo.src = t.home_logo;
        if (t.away_logo) awayLogo.src = t.away_logo;

        // Info dasar
        card.querySelector(".match-title").textContent = `${t.match_home} vs ${t.match_away}`;
        card.querySelector(".match-meta").textContent = `${t.venue} â€¢ ${t.date}`;
        card.querySelector(".seat-category").textContent = t.seat_category;

        // Status badge
        const statusBadge = card.querySelector(".status-badge");
        const now = new Date();
        const matchDate = new Date(t.match_iso);
        if (matchDate > now) {
            statusBadge.textContent = "Aktif";
            statusBadge.classList.add("bg-green-100", "text-green-700");
        } else {
            statusBadge.textContent = "Selesai";
            statusBadge.classList.add("bg-gray-200", "text-gray-600");

            // tombol review muncul
            const reviewBtn = node.querySelector(".review-btn");
            reviewBtn.classList.remove("hidden");
            reviewBtn.addEventListener("click", () => {
              currentMatchId = t.match_id;
              modal.classList.remove("hidden");
            });
        }

        // Barcode
        const barcode = card.querySelector(".barcode");
        JsBarcode(barcode, t.barcode_code, {
          format: "CODE128",
          lineColor: "#111",
          width: 2,
          height: 45,
          displayValue: true,
          fontSize: 12,
          margin: 0
        });

        // Tombol download per tiket
        const downloadBtn = node.querySelector(".download-btn");
        downloadBtn.addEventListener("click", async () => {
          const cardEl = card.cloneNode(true);
          const temp = document.createElement("div");
          temp.style.position = "fixed";
          temp.style.left = "-9999px";
          temp.appendChild(cardEl);
          document.body.appendChild(temp);

          const canvas = await html2canvas(cardEl, { scale: 3 });
          const dataUrl = canvas.toDataURL("image/png");

          const a = document.createElement("a");
          a.download = `ticket-${t.ticket_id}.png`;
          a.href = dataUrl;
          a.click();

          document.body.removeChild(temp);
        });

        container.appendChild(node);
      });
    })
    .catch(err => {
      console.error(err);
      loading.textContent = "Gagal memuat tiket.";
    });
});

let currentMatchId = null;
let selectedRating = 0;
const modal = document.getElementById("review-modal");

// Toggle bintang aktif
document.querySelectorAll("#rating-stars .star").forEach(star => {
  star.addEventListener("click", () => {
    selectedRating = parseInt(star.dataset.value);
    document.querySelectorAll("#rating-stars .star").forEach(s => {
      s.classList.toggle("text-yellow-400", parseInt(s.dataset.value) <= selectedRating);
      s.classList.toggle("text-gray-300", parseInt(s.dataset.value) > selectedRating);
    });
  });
});

document.getElementById("cancel-review").addEventListener("click", () => {
  modal.classList.add("hidden");
  selectedRating = 0;
  document.getElementById("review-text").value = "";
  document.querySelectorAll("#rating-stars .star").forEach(s => s.classList.replace("text-yellow-400", "text-gray-300"));
});

document.getElementById("submit-review").addEventListener("click", async () => {
  const text = document.getElementById("review-text").value.trim();
  if (!selectedRating || !text) {
    alert("Mohon isi rating dan ulasan terlebih dahulu!");
    return;
  }

  try {
    // BAGIAN INI (FIX YOOWWW)
    const res = await fetch(`/reviews/create/${currentMatchId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({
        rating: selectedRating,
        comment: text
      })
    });

    const data = await res.json();
    if (data.ok) {
      alert("Terima kasih atas ulasan Anda!");
      modal.classList.add("hidden");
    } else {
      alert(data.message || "Gagal mengirim review.");
    }
  } catch (e) {
    console.error(e);
    alert("Terjadi kesalahan. Coba lagi nanti.");
  }
});
</script>
{% endblock profile_content %}
