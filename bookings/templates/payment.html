{% extends "base.html" %}
{% block title %}Pembayaran Booking{% endblock %}
{% load static %}
{% block content %}
{% include "components/step_wizard.html" with step=3 %}
<style>
.payment-grid {
  display: grid;
  grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); /* Flexible columns */
  gap: 32px;
  padding: 40px 60px;
  background: #f3f4f6 !important;
  min-height: 100vh;
  font-family: "Inter", sans-serif;
  color: #111827 !important;
}

/* === LEFT BOX === */
.left-box {
  background: #ffffff;
  padding: 30px 36px;
  border-radius: 14px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
}

.page-title {
  color: #2563eb;
  font-size: 1.8em;
  font-weight: 700;
  margin-top: 0;
  margin-bottom: 6px;
}

.booking-id {
  color: #6b7280;
  font-size: 0.9em;
  font-family: monospace;
}

.alert-warning {
  background: #fffbeb; /* Warna kuning lebih soft */
  border-left: 4px solid #f59e0b; /* Border kiri */
  color: #b45309; /* Warna teks lebih gelap */
  border-radius: 8px;
  padding: 12px 16px;
  margin: 20px 0;
  font-size: 0.9em;
  font-weight: 500;
}
.alert-warning::before { /* Tambah ikon warning */
    content: "⚠️";
    margin-right: 8px;
    font-size: 1.1em;
}

.info p {
  margin: 8px 0;
  font-size: 0.95em;
  color: #374151;
}
.info p strong {
    color: #111827;
}

.result-box {
  margin-top: 24px;
  min-height: 250px; /* Jaga tinggi saat loading */
  display: flex; /* Untuk centering loading */
  flex-direction: column;
  justify-content: center;
}

.loading-spinner {
  border: 4px solid #f3f4f6;
  border-top: 4px solid #3b82f6;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.loading-text {
  color: #6b7280;
  font-weight: 500;
  text-align: center;
}

.va-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 12px; /* Lebih rounded */
  padding: 24px;
  text-align: left; /* Rata kiri */
}

.va-header {
  display: flex;
  align-items: center;
  gap: 16px; /* Jarak logo & teks */
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 16px;
  margin-bottom: 16px;
}

.bank-logo {
  height: 40px;
  max-width: 100px;
  object-fit: contain;
}

.va-header h3 {
  margin: 0;
  font-size: 1.2em;
  font-weight: 600; /* Sedikit tebal */
  color: #111827;
}

.va-content {
  padding: 16px 0;
}

.va-label {
  font-size: 0.85em; /* Label lebih kecil */
  color: #6b7280;
  margin-bottom: 6px; /* Jarak ke box nomor */
  display: block; /* Pastikan block */
}

.va-number-box {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #ffffff;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 12px 16px;
}

.va-number-text {
  font-size: 1.6em;
  font-weight: 700;
  color: #2563eb;
  font-family: 'Courier New', monospace;
  letter-spacing: 1px;
  word-break: break-all; /* Agar nomor panjang tidak overflow */
}

.copy-btn {
  background: #e0e7ff;
  color: #3730a3;
  border: none;
  border-radius: 6px;
  padding: 8px 12px; /* Sedikit lebih besar */
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9em;
  margin-left: 12px; /* Jarak dari nomor */
  white-space: nowrap; /* Jangan wrap text 'Salin' */
}
.copy-btn:hover {
  background: #c7d2fe;
}
.copy-btn:active {
    transform: scale(0.95);
}

.va-footer {
  border-top: 1px solid #e5e7eb;
  padding-top: 16px;
  margin-top: 16px;
}
.va-footer .status {
  margin: 0 0 4px 0;
  font-weight: 600;
  color: #374151;
  font-size: 0.95em;
}
.va-footer .note {
  margin: 0;
  font-size: 0.9em;
  color: #6b7280;
}

/* === QRIS === */
.qr-card {
  background: #f9fafb;
  padding: 24px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  text-align: center;
}
.qr-card h3 {
    margin-top: 0;
    margin-bottom: 16px;
}

.qr-card img.qr-image {
  width: 220px;
  height: 220px;
  display: block;
  margin: 16px auto;
  border-radius: 8px; /* Lebih smooth */
  border: 1px solid #d1d5db;
}
.qr-card .btn-primary { /* Tombol 'Buka Aplikasi' */
    margin-top: 16px;
}
.qr-card .status { /* Status 'Menunggu pembayaran' */
    margin-top: 16px;
    font-weight: 500;
    color: #374151;
}

/* === CARD FORM === */
.form-card {
  margin-top: 24px;
}

.form-card h3 {
  font-size: 1.25em; /* Sedikit lebih besar */
  font-weight: 600;
  color: #111827; /* Warna teks biasa */
  margin-bottom: 16px;
}

.form-card label {
  display: block;
  font-weight: 500; /* Normal weight */
  margin-bottom: 4px; /* Jarak ke input */
  margin-top: 12px; /* Jarak antar field */
  font-size: 0.9em;
  color: #374151;
}

.form-card input {
  width: 100%;
  padding: 10px 12px; /* Padding lebih nyaman */
  border: 1px solid #d1d5db;
  border-radius: 8px; /* Lebih rounded */
  font-size: 1em;
}
.form-card input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}


.form-row {
  display: grid; /* Ganti ke grid agar lebih rapi */
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 4px; /* Dekatkan ke label */
}
/* Hapus margin top dari label di form-row */
.form-row label {
    margin-top: 0;
}

.btn-primary {
  display: inline-block;
  background: #2563eb;
  color: white;
  padding: 12px 18px; /* Padding lebih besar */
  border-radius: 8px;
  font-weight: 600;
  margin-top: 24px; /* Jarak lebih jauh */
  cursor: pointer;
  border: none;
  transition: all 0.2s; /* Transisi semua properti */
  width: 100%; /* Tombol bayar kartu full width */
}
.btn-primary:hover {
  background: #1d4ed8;
  box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); /* Shadow on hover */
}
.btn-primary:active {
    transform: scale(0.98);
}
.hidden { display: none !important; }

/* === RIGHT BOX === */
.right-box {
  background: #ffffff;
  padding: 24px 28px;
  border-radius: 14px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  height: fit-content;
  position: sticky; /* Tetap terlihat saat scroll */
  top: 40px;
}

.summary-card h3 {
  color: #111827; /* Warna teks biasa */
  font-weight: 600;
  border-bottom: 1px solid #e5e7eb; /* Border lebih tipis */
  padding-bottom: 12px;
  margin-bottom: 16px;
  font-size: 1.2em;
}

.summary-item {
  display: grid; /* Pakai grid */
  grid-template-columns: 1fr auto;
  gap: 4px;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px dotted #e5e7eb; /* Dotted separator */
  font-size: 0.9em;
}
.summary-item strong { font-weight: 600; }
.summary-item .seat {
  color: #6b7280;
  font-weight: 500;
  text-align: right;
}
/* Hilangkan border bawah item terakhir */
.summary-item:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}


.summary-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 2px solid #2563eb; /* Border biru tebal */
  font-weight: 700;
  font-size: 1.1em; /* Ukuran font total */
  color: #111827;
}
.summary-total strong {
    font-size: 1.4em; /* Harga total lebih besar */
    color: #2563eb; /* Biru */
}

/* ================================== */
/* === STYLING TOMBOL REFRESH === */
/* ================================== */
.refresh-box {
  border-top: 1px solid #e5e7eb;
  padding-top: 20px;
  margin-top: 20px;
  text-align: center; /* Center tombol & teks */
}

.refresh-btn {
  background: #ffffff;
  color: #374151;
  border: 1px solid #d1d5db;
  padding: 10px 16px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  width: auto; /* Jangan full-width, biarkan auto */
  font-size: 0.95em;
  display: inline-flex; /* Agar icon dan text sejajar */
  align-items: center;
  gap: 8px;
}
.refresh-btn:hover {
  background: #f9fafb;
  border-color: #9ca3af;
}
.refresh-btn:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
  border-color: #e5e7eb;
}
/* Ikon refresh (gunakan SVG atau font icon jika ada) */
.refresh-btn svg {
    width: 16px;
    height: 16px;
    /* Tambahkan animasi spin jika sedang loading */
}
.refresh-btn.loading svg {
    animation: spin 1s linear infinite;
}


#manual-status-text {
  margin-top: 12px; /* Jarak dari tombol */
  font-size: 0.9em;
  font-weight: 500;
  min-height: 1.2em; /* Jaga tinggi agar tidak lompat */
}
/* Warna status text */
#manual-status-text.pending { color: #f59e0b; }
#manual-status-text.error { color: #dc2626; }
#manual-status-text.checking { color: #6b7280; }


/* ================================== */
/* === STYLING MODAL SUKSES === */
/* ================================== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
  padding: 20px; /* Padding agar modal tidak nempel di edge */
}

.modal-box {
  background: white;
  padding: 32px 40px; /* Padding horizontal lebih banyak */
  border-radius: 16px;
  text-align: center;
  width: 100%; /* Width 100% di mobile */
  max-width: 450px;
  transform: scale(0.9);
  transition: all 0.3s ease;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.modal-overlay.show {
  opacity: 1;
}
.modal-overlay.show .modal-box {
  transform: scale(1);
}

.modal-icon {
  width: 70px; /* Sedikit lebih kecil */
  height: 70px;
  margin-bottom: 20px;
}

.modal-box h2 {
  color: #16a34a;
  font-size: 1.7em; /* Lebih besar */
  margin-bottom: 12px;
  font-weight: 700;
}

.modal-box p {
  color: #374151;
  font-size: 1em;
  line-height: 1.6;
  margin-bottom: 28px; /* Jarak lebih jauh ke tombol */
}

.modal-buttons {
  display: flex;
  flex-direction: column; /* Tombol atas bawah di mobile */
  gap: 12px;
}
.modal-buttons .btn-primary,
.modal-buttons .btn-secondary {
  width: 100%;
  text-decoration: none;
  padding: 12px 18px; /* Padding konsisten */
  font-size: 1em;
  margin-top: 0; /* Hapus margin top default */
}
.modal-buttons .btn-secondary {
  background: #ffffff;
  color: #374151;
  border: 1px solid #d1d5db;
}
.modal-buttons .btn-secondary:hover {
  background: #f9fafb;
  border-color: #9ca3af;
}
/* Layout tombol side-by-side di layar lebih besar */
@media (min-width: 400px) {
    .modal-buttons {
        flex-direction: row;
    }
}


/* === RESPONSIVE === */
@media (max-width: 900px) {
  .payment-grid {
    grid-template-columns: 1fr; /* Stack layout */
    padding: 24px; /* Kurangi padding */
  }
  .right-box {
    position: static; /* Hapus sticky */
    margin-top: 0; /* Hapus gap */
  }
}
@media (max-width: 600px) {
    .payment-grid {
        padding: 16px;
    }
    .left-box, .right-box {
        padding: 20px; /* Kurangi padding card */
    }
    .page-title { font-size: 1.5em; }
    .va-number-text { font-size: 1.4em; }
    .summary-total strong { font-size: 1.2em; }
    .form-row { grid-template-columns: 1fr; } /* Stack input CC di mobile */
}

</style>

<div class="payment-grid">
  <section class="left-box">
    <h1 class="page-title">Pembayaran Booking</h1>
    <p class="booking-id">Booking ID: {{ booking.booking_id|slice:":8" }}</p>

    <div class="alert-warning">
      Jangan tutup atau refresh halaman ini selama proses pembayaran berlangsung.
    </div>

    <div class="info">
      <p><strong>Status:</strong> <span id="booking-status">{{ booking.get_status_display }}</span></p>
      <p><strong>Tanggal Pemesanan:</strong> {{ booking.created_at|date:"d M Y, H:i" }}</p>
      <p><strong>Nama Pemesan:</strong> {{ booking.user.username }}</p>
    </div>

    <div id="result-box" class="result-box">
      <div class="loading-spinner"></div>
      <p class="loading-text">Menyiapkan pembayaran untuk <strong>{{ selected_method|upper }}</strong>...</p>
    </div>

    </section>

  <aside class="right-box">
    <div class="summary-card">
      <h3>Ringkasan Pesanan</h3>
      {% for item in booking.items.all %}
      <div class="summary-item">
        <div>
          <strong>{{ item.ticket_type.match.home_team.name }}</strong> vs
          <strong>{{ item.ticket_type.match.away_team.name }}</strong>
        </div>
        <div class="seat">{{ item.ticket_type.seat_category }} × {{ item.quantity }}</div>
      </div>
      {% endfor %}
      <div class="summary-total">
        <span>Total Pembayaran</span>
        <strong>Rp {{ booking.total_price|floatformat:0 }}</strong>
      </div>
    </div>
  </aside>
</div>

<div id="success-modal-overlay" class="modal-overlay hidden">
  <div class="modal-box">
    <img src="{% static 'images/success-icon.png' %}" alt="Success" class="modal-icon">
    <h2>Pembayaran Berhasil!</h2>
    <p>Tiket Anda sudah diterbitkan dan dapat dilihat di halaman profil.</p>
    <div class="modal-buttons">
      <a href="{% url 'profiles:user_tickets_page' %}" class="btn-secondary">Lihat Tiket</a>
      <a href="{% url 'main:home' %}" class="btn-primary">Kembali ke Home</a>
    </div>
  </div>
</div>

<div id="confirm-modal-overlay" class="modal-overlay hidden">
  <div class="modal-box">
    <h2>Periksa Status Pembayaran?</h2>
    <p>Pastikan Anda sudah menyelesaikan pembayaran di aplikasi bank atau e-wallet sebelum melanjutkan.</p>
    <div class="modal-buttons">
      <button id="confirm-refresh" class="btn-primary">Ya, Periksa Sekarang</button>
      <button id="cancel-refresh" class="btn-secondary">Nanti Saja</button>
    </div>
  </div>
</div>



<script src="https://api.midtrans.com/v2/assets/js/midtrans-new-3ds.min.js"
  data-environment="sandbox"
  data-client-key="{{ MIDTRANS_CLIENT_KEY }}">
</script>

<script>
  const bookingId = "{{ booking.booking_id }}";
  const selectedMethod = "{{ selected_method|default:'' }}";
  const csrftoken = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || "";
  const resultBox = document.getElementById("result-box");

  let paymentInProgress = true;

  window.addEventListener("beforeunload", e => {
    if (paymentInProgress) {
      e.preventDefault();
      e.returnValue = "Jangan tutup halaman ini selama proses pembayaran berlangsung!";
    }
  });

  function addCopyListener(textToCopy, buttonId = 'copy-btn') {
    const copyBtn = document.getElementById(buttonId);
    if (copyBtn) {
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(textToCopy).then(() => {
          showToast("📋 Nomor berhasil disalin!", "success");
          copyBtn.textContent = 'Disalin!';
          copyBtn.style.background = '#16a34a';
          copyBtn.style.color = 'white';
          setTimeout(() => {
            copyBtn.textContent = 'Salin';
            copyBtn.style.background = '#e0e7ff';
            copyBtn.style.color = '#3730a3';
          }, 1500);
        }).catch(err => {
          console.error('Gagal menyalin: ', err);
          copyBtn.textContent = 'Gagal!';
        });
      });
    }
  }

  function showSuccessModal() {
    const overlay = document.getElementById("success-modal-overlay");
    if (overlay) {
      overlay.classList.remove("hidden");
      setTimeout(() => {
        overlay.classList.add("show");
      }, 10);
    }
  }

  async function manualCheckStatus() {
    const refreshBtn = document.getElementById('refresh-status-btn');
    const statusText = document.getElementById('manual-status-text');

    if (refreshBtn) {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('loading');
      refreshBtn.querySelector('span').textContent = 'Mengecek...';
    }
    if (statusText) {
      statusText.textContent = 'Mengecek status pembayaran...';
      statusText.className = 'checking';
    }

    try {
      const res = await fetch(`/bookings/check_status/${bookingId}/`);
      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.error || `HTTP error! status: ${res.status}`);
      }
      
      const data = await res.json();
      
      if (data.status === "CONFIRMED") {
        paymentInProgress = false;
        showSuccessModal();
      
      } else if (data.status === "EXPIRED" || data.status === "CANCELLED" || data.status === "DENY") {
        paymentInProgress = false;
        resultBox.innerHTML = `
          <div class="va-card" style="border-color: #fecaca; background: #fef2f2;">
            <h3 style="color: #dc2626;">Pembayaran Gagal / Dibatalkan</h3>
            <p class="note">Status booking ini adalah: <strong>${data.status}</strong></p>
            <p class="note" style="margin-top: 10px;">Anda bisa mencoba membuat booking baru jika diinginkan.</p>
            <a href="/" class="btn-primary" style="margin-top: 20px; width: auto; padding: 10px 20px;">Kembali ke Home</a>
          </div>
        `;
      
      } else {
        // Masih PENDING
        showToast("⌛ Pembayaran masih tertunda. Silakan coba cek lagi.", "info");
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.classList.remove('loading');
          refreshBtn.querySelector('span').textContent = 'Cek Ulang Status';
        }
        if (statusText) {
          statusText.textContent = 'Pembayaran masih tertunda. Silakan coba cek lagi beberapa saat.';
          statusText.className = 'pending';
        }
      }
      
    } catch (err) {
      showToast(`❌ Gagal mengecek status: ${err.message}`, "error");
      if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('loading');
        refreshBtn.querySelector('span').textContent = 'Cek Status Pembayaran';
      }
      if (statusText) {
        statusText.textContent = `Gagal mengecek status: ${err.message}. Coba lagi.`;
        statusText.className = 'error';
      }
    }
  }

  function getRefreshButtonHTML() {
    return `
      <div class="refresh-box">
        <p class="note" style="text-align:center; margin-bottom:12px;">Sudah melakukan pembayaran? Klik tombol di bawah untuk memeriksa status.</p>
        <button id="refresh-status-btn" class="refresh-btn">
          <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
          </svg>
          <span>Cek Status Pembayaran</span>
        </button>
        <p id="manual-status-text" class="note checking" style="text-align:center; min-height: 1.2em;"></p>
      </div>
    `;
  }

  function getCardFormHTML() {
      return `
      <div id="form-card" class="form-card" style="text-align: left;">
        <h3>Detail Kartu Kredit / Debit</h3>
        <label for="card_number">Nomor Kartu</label>
        <input type="text" id="card_number" placeholder="4111 1111 1111 ....">

        <div class="form-row">
          <div>
            <label for="card_exp_month">Bulan Exp</label>
            <input type="number" id="card_exp_month" placeholder="MM">
          </div>
          <div>
            <label for="card_exp_year">Tahun Exp</label>
            <input type="number" id="card_exp_year" placeholder="YYYY">
          </div>
          <div>
            <label for="card_cvv">CVV</label>
            <input type="number" id="card_cvv" placeholder="123">
          </div>
        </div>
        <button id="pay-card" class="btn-primary">Bayar Sekarang</button>
        <p id="card-error-text" class="error" style="text-align: center; margin-top: 10px;"></p> </div>
      `;
  }

  function displayPaymentResult(data) {
    resultBox.innerHTML = ""; // Bersihkan loading awal

    if (data.error) {
      resultBox.innerHTML = `<p class="error" style="font-weight: bold;">${data.error}</p>`;
      paymentInProgress = false;
      return;
    }
    
    if (data.message && data.midtrans_data) {
      data = data.midtrans_data;
    }

    const currentStatus = data.transaction_status;

    if (currentStatus === "settlement" || currentStatus === "capture") {
      paymentInProgress = false;
      showSuccessModal();
      showToast("🎉 Pembayaran berhasil! Tiket Anda telah diterbitkan.", "success");
      return;
    }
    if (currentStatus === "expire" || currentStatus === "cancel" || currentStatus === "deny") {
      showToast("❌ Pembayaran gagal atau dibatalkan.", "error");
      paymentInProgress = false;
      resultBox.innerHTML = `
        <div class="va-card" style="border-color: #fecaca; background: #fef2f2;">
          <h3 style="color: #dc2626;">Pembayaran Gagal / Dibatalkan</h3>
          <p class="note">Status transaksi ini adalah: <strong>${currentStatus.toUpperCase()}</strong></p>
          <a href="/" class="btn-primary" style="margin-top: 20px; width: auto; padding: 10px 20px;">Kembali ke Home</a>
        </div>
      `;
      return;
    }

    paymentInProgress = true; 

    const logos = {
        bca: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Bank_Central_Asia.svg/512px-Bank_Central_Asia.svg.png",
        bni: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Bank_Negara_Indonesia_logo_%282004%29.svg/512px-Bank_Negara_Indonesia_logo_%282004%29.svg.png",
        bri: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/BANK_BRI_logo.svg/512px-BANK_BRI_logo.svg.png",
        cimb: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/67/CIMB_Niaga_logo.svg/512px-CIMB_Niaga_logo.svg.png"
    };

    let instructionHTML = '';

    // --- BANK TRANSFER (VA LAINNYA) ---
    if (selectedMethod.startsWith("bank_") && data.va_numbers && data.va_numbers.length > 0) {
      const va = data.va_numbers[0];
      const bank = va.bank.toLowerCase();
      const logo = logos[bank] || "";
      instructionHTML = `
        <div class="va-card">
          <div class="va-header">
            <img src="${logo}" alt="${va.bank}" class="bank-logo">
            <h3>Virtual Account ${va.bank.toUpperCase()}</h3>
          </div>
          <div class="va-content">
            <p class="va-label">Nomor Virtual Account</p>
            <div class="va-number-box">
              <span class="va-number-text">${va.va_number}</span>
              <button id="copy-btn" class="copy-btn">Salin</button>
            </div>
          </div>
          <div class="va-footer">
            <p class="status">Status: ${currentStatus.toUpperCase()}</p>
            <p class="note">Gunakan nomor VA di atas untuk melakukan pembayaran.</p>
          </div>
          ${getRefreshButtonHTML()}
        </div>`;
      resultBox.innerHTML = instructionHTML;
      addCopyListener(va.va_number, 'copy-btn');
      return;
    }

    // --- QRIS / GOPAY ---
    if (selectedMethod === "gopay" && data.actions && data.actions.length > 0) {
      let qrAction = data.actions.find(a => a.name === "generate-qr-code-v2");
      if (!qrAction) {
        qrAction = data.actions.find(a => a.name === "generate-qr-code");
      }
      const deeplinkAction = data.actions.find(a => a.name.includes("deeplink"));

      if (qrAction) {
        instructionHTML = `
          <div class="qr-card">
            <h3>Scan QR Code</h3>
            <img src="${qrAction.url}" alt="QRIS" class="qr-image">
            ${deeplinkAction ? `<a href="${deeplinkAction.url}" target="_blank" class="btn-primary" style="width:auto; padding: 10px 20px; margin-top: 16px;">Buka di Aplikasi</a>` : ""}
            <p class="status" style="margin-top:16px;">Menunggu pembayaran...</p>
            ${getRefreshButtonHTML()}
          </div>`;
        resultBox.innerHTML = instructionHTML;
        return;
      }
    }

    // --- CARD (Redirect) ---
    if (selectedMethod === "card" && data.redirect_url) {
      resultBox.innerHTML = `<div class="loading-spinner"></div><p class="loading-text">Mengarahkan ke halaman verifikasi aman...</p>`;
      window.midtransNew3ds(data.redirect_url, {
        onSuccess: r => {
          paymentInProgress = false;
          showSuccessModal();
        },
        onPending: r => {
          resultBox.innerHTML = `<h3 style="color: #f59e0b;">Pembayaran Pending</h3><p>${r.status_message}</p>`;
          paymentInProgress = false;
        },
        onError: r => {
          resultBox.innerHTML = `<h3 class="error" style="color: #dc2626;">Pembayaran Gagal</h3><p>${r.status_message}</p>`;
          paymentInProgress = false;
        },
      });
      return;
    }

    // --- CARD (Form) ---
    if (selectedMethod === "card") {
        resultBox.innerHTML = getCardFormHTML();
        document.getElementById("pay-card").addEventListener("click", handleCardPayment);
        return;
    }

    // --- Fallback ---
    paymentInProgress = false;
    console.error("Tidak bisa menampilkan instruksi:", data);
    resultBox.innerHTML = `<p class="error" style="font-weight: bold;">Gagal menampilkan instruksi pembayaran.</p><p>Status Transaksi: ${currentStatus || "Unknown"}</p>`;
  }

  async function initiatePayment(payload) {
    resultBox.innerHTML = `<div class="loading-spinner"></div><p class="loading-text">Menghubungi Midtrans...</p>`;
    try {
      const res = await fetch(`/bookings/payment/${bookingId}/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) {
        // Ini akan menangkap error 410 (session expired) atau 500 (midtrans down)
        throw new Error(data.error || data.status_message || `HTTP error! status: ${res.status}`);
      }
      displayPaymentResult(data);
    } catch (err) {
      showToast(`❌ Gagal memulai pembayaran: ${err.message}`, "error");
      resultBox.innerHTML = `<p class="error" style="font-weight: bold;">Gagal memulai pembayaran:</p><p class="error">${err.message}</p>`;
      paymentInProgress = false;
    }
  }

  function handleCardPayment() {
    const cardData = {
      card_number: document.getElementById('card_number').value.replace(/\s/g, ''),
      card_exp_month: document.getElementById('card_exp_month').value,
      card_exp_year: document.getElementById('card_exp_year').value,
      card_cvv: document.getElementById('card_cvv').value
    };
    const errorText = document.getElementById('card-error-text');
    errorText.textContent = '';

    if (!cardData.card_number || !/^\d+$/.test(cardData.card_number)) {
      errorText.textContent = 'Nomor kartu tidak valid.'; return;
    }
    if (!cardData.card_exp_month || !/^\d{1,2}$/.test(cardData.card_exp_month) || cardData.card_exp_month < 1 || cardData.card_exp_month > 12) {
      errorText.textContent = 'Bulan expired tidak valid.'; return;
    }
    if (!cardData.card_exp_year || !/^\d{4}$/.test(cardData.card_exp_year) || cardData.card_exp_year < new Date().getFullYear()) {
      errorText.textContent = 'Tahun expired tidak valid.'; return;
    }
    if (!cardData.card_cvv || !/^\d{3,4}$/.test(cardData.card_cvv)) {
      errorText.textContent = 'CVV tidak valid.'; return;
    }

    resultBox.innerHTML = `<div class="loading-spinner"></div><p class="loading-text">Memvalidasi kartu...</p>`;

    MidtransNew3ds.getCardToken(cardData, {
      onSuccess: function(response) {
        initiatePayment({ method: "card", token_id: response.token_id });
      },
      onError: function(response) {
        resultBox.innerHTML = getCardFormHTML();
        document.getElementById('card-error-text').textContent = response.message;
        document.getElementById("pay-card").addEventListener("click", handleCardPayment);
        paymentInProgress = false;
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (!selectedMethod) {
        resultBox.innerHTML = `<p class="error" style="font-weight: bold;">Metode pembayaran tidak ditemukan.</p><p>Silakan kembali dan pilih metode pembayaran.</p>`;
        paymentInProgress = false;
        return;
    }

    if (selectedMethod === "card") {
      resultBox.innerHTML = getCardFormHTML();
      document.getElementById("pay-card").addEventListener("click", handleCardPayment);
      paymentInProgress = true;
    } else {
      const payload = { method: selectedMethod };
      if (selectedMethod.startsWith("bank_")) {
          payload.bank = selectedMethod.split("_")[1];
      }
      initiatePayment(payload);
    }
  });

  document.addEventListener("click", e => {

    if (e.target.closest && e.target.closest("#refresh-status-btn")) {
      e.preventDefault();
      const confirmModal = document.getElementById("confirm-modal-overlay");
      if (!confirmModal) {
        console.error("Modal konfirmasi tidak ditemukan");
        return;
      }

      confirmModal.classList.remove("hidden");
      setTimeout(() => confirmModal.classList.add("show"), 10);

      const confirmBtn = document.getElementById("confirm-refresh");
      const cancelBtn = document.getElementById("cancel-refresh");

      confirmBtn.onclick = () => {
        confirmModal.classList.remove("show");
        setTimeout(() => confirmModal.classList.add("hidden"), 300);
        showToast("🔄 Mengecek status pembayaran...", "info");
        manualCheckStatus();
      };

      cancelBtn.onclick = () => {
        confirmModal.classList.remove("show");
        setTimeout(() => confirmModal.classList.add("hidden"), 300);
      };
    }
  });
</script>
{% endblock %}